let count=0,golgi={dataStore:{},components:[],assemblies:new Map,stateMap:new Map,resourceLoaded:new Map,listeners:new Map,logging:!1,version:"1.4.2",setLog:function(e){this.logging=e},loadJSAsync:async function(e,t){return await golgi.loadJSFilePromise(e,t)},loadJSFilePromise:async function(e,t){let o=this;return new Promise(n=>{o.loadJS(e,t,function(e){n(e)})})},loadJS:function(e,t,o){let n;t&&(o||"function"!=typeof t?"object"==typeof t&&(n=t.crossorigin):o=t);let i=document.createElement("script");i.type="text/javascript",i.src=e;let a=this;i.onload=function(){a.logMessage("script "+e+" loaded"),o&&o(e)},n&&i.setAttribute("crossorigin",n),document.body.appendChild(i)},loadCSSAsync:async function(e,t){return await golgi.loadCSSPromise(e,t)},loadCSSPromise:async function(e,t){let o=this;return new Promise(n=>{o.loadCSS(e,t,function(e){n(e)})})},loadCSS:function(e,t,o){let n;t&&(o||"function"!=typeof t?"object"==typeof t&&(n=t.crossorigin,(t=t.target)||(t=document.getElementsByTagName("head")[0])):(o=t,t=document.getElementsByTagName("head")[0])),t||(t=document.getElementsByTagName("head")[0]);let i=t,a=document.createElement("link");a.rel="stylesheet",a.setAttribute("type","text/css"),a.href=e,n&&a.setAttribute("crossorigin",n);let s=this;a.onload=function(){s.logMessage("CSS file "+e+" loaded"),o&&o(e)},i.appendChild(a)},addMetaTag:function(e){let t,o=document.createElement("meta");for(t in e)o.setAttribute(t,e[t]);document.getElementsByTagName("head")[0].appendChild(o)},fetch_optimised_components:async function(e,t){let o=t||"golgi-components.js";this.logMessage("fetching optimised file of all components: "+o);const{golgi_components:n}=await import(o);let i=this;n.forEach(function(e){if(!customElements.get(e.n))try{e.f(),i.logMessage(e.n+" loaded")}catch(e){i.logMessage("Unable to fetch optimised component module"),console.log(e)}})},fetch_optimised_assemblies:async function(e,t){let o=t||"golgi-assemblies.js",n=e.assemblyPath+o;this.logMessage("fetching optimised file of all assemblies: "+n);let i=this;try{const{golgi_assemblies:e}=await import(n);e.forEach(function(e){i.assemblies.set(e.n,e.c)})}catch(e){this.logMessage("Unable to fetch optimised assembly module")}this.emit("assembliesLoaded")},load:async function(e,t,o){let n=e.split("-")[0];this.logMessage("*** load "+e);let i=o.componentPath||"./";o.componentPaths&&o.componentPaths[n]&&(i=o.componentPaths[n]);let a=i;function s(e){let n=new e;return t?t.appendChild(n):golgi.components.push(n),n.context=o,n.path=i,n.rootPath=a,n.isComponent=!0,n}"/"!==a.slice(-1)&&(a=i+"/");let l=customElements.get(e);if(l){return this.logMessage("** component "+e+" already imported"),s(l)}{let t=await import(i+e+".js");o.golgiLoadSequence||(o.golgiLoadSequence=[]),o.golgiLoadSequence.push(e),this.logging&&(this.logMessage("Component Load Sequence so far:"),console.log(o.golgiLoadSequence));let n=customElements.get(e);return n||(t.load.call(this),n=customElements.get(e),this.logMessage("** component "+e+" had to be imported")),s(n)}},loadGroup:async function(e,t,o){"body"===t&&(t=document.getElementsByTagName("body")[0]),o=o||{},Array.isArray(e)||(e=[e]);let n=e[0].assemblyName;for(const i of e)await this.processComponent(i,n,t,o)},processComponent:async function(e,t,o,n){let i=o;if(e.targetElement){let t=this.getParentComponent.call(i,e.targetElement.componentName);t&&t[e.targetElement.target]&&(i=t[e.targetElement.target])}if("assembly"===e.componentName.split(":")[0]){let t=e.componentName.split("assembly:")[1];if(await this.renderAssembly(t,i,n),e.hook)try{e.hook.call(this,n)}catch(e){this.logging&&(this.logMessage("Unable to execute hook "+name+" for "+config.componentName),console.log(e))}return}let a=await this.loadComponent(e,t,i,n);e.children&&e.children[0]&&a.childrenTarget&&(e.children.forEach(function(o,n){e.children[n].assemblyName=t}),await this.loadGroup(e.children,a.childrenTarget,n))},loadComponent:async function(e,t,o,n){let i=Object.assign({},e);if(!i.componentName.includes("-")&&!i.componentName.includes(":")){let e=document.createElement(i.componentName);e.textContent=i.textContent;for(let t in i.attributes)e.setAttribute(t,i.attributes[t]);if(e.childrenTarget=e,o&&o.appendChild(e),i.hook)try{let t={...this};t.element=e,"AsyncFunction"===i.hook.constructor.name?await i.hook.call(t,n):i.hook.call(t,n)}catch(e){this.logging&&(this.logMessage("Unable to execute hook "+name+" for "+i.componentName),console.log(e))}return e}i.meta&&i.meta.forEach(function(e){golgi.addMetaTag(e)});await Promise.all(["script","css"].map(async e=>{"script"===e&&i.script&&await Promise.all(i.script.map(async e=>{if(!golgi.resourceLoaded.has(e.src)){let t;e.crossorigin&&(t={crossorigin:e.crossorigin}),e.await?await golgi.loadJSAsync(e.src,t):golgi.loadJS(e.src,t),golgi.resourceLoaded.set(e.src,!0)}})),"css"===e&&i.css&&await Promise.all(i.css.map(async e=>{if(!golgi.resourceLoaded.has(e.src)){let t;e.crossorigin&&(t={crossorigin:e.crossorigin}),e.await?await golgi.loadCSSAsync(e.src,t):golgi.loadCSS(e.src,t),golgi.resourceLoaded.set(e.src,!0)}}))}));let a=await this.renderWebComponent(i,o,n);return a.parentComponent&&a.parentComponent.onChildComponentReady&&a.parentComponent.onChildComponentReady.call(a.parentComponent,a),a},renderWebComponent:async function(e,t,o){let n,i=e.assemblyName,a=await this.load(e.componentName,t,o);if(this.logging,a.shadowRoot){if(a.rootElement=a.shadowRoot.firstElementChild,"STYLE"===a.rootElement.tagName){let e=!1,t=a.rootElement;do{t.nextSibling&&1===(t=t.nextSibling).nodeType&&(e=!0)}while(!e);a.rootElement=e?t:a.shadowRoot.firstElementChild}n=a.shadowRoot.querySelectorAll("*")}else void 0!==a.html&&(a.innerHTML=a.html,a.rootElement=a.firstElementChild,n=a.querySelectorAll("*"));if(void 0!==a.rootElement){a.databinding=[],n.forEach(function(e){if(e.hasAttribute("golgi:prop")){let t=e.getAttribute("golgi:prop");a[t]=e,e.removeAttribute("golgi:prop")}e.ownerComponent=a,e.childNodes.forEach(function(t){if(3===t.nodeType){let o=t.nodeValue.toString();if(t.nodeValue.includes("golgi:bind")){let o=t.nodeValue.split("golgi:bind=")[1]||"dummy";o=o.split(";")[0];let n=document.createElement("span");e.insertBefore(n,t);let i=function(e){let t=e;"object"==typeof e&&(t=e[o]),void 0!==t&&(n.innerHTML=t)};a.databinding.push(i),t.nodeValue=""}if(o.includes("golgi:observer")){let t=e;e.firstChild&&"SPAN"===e.firstChild.tagName&&(t=e.firstChild);let n=o.split("golgi:observer=")[1];n=n.split(";")[0],golgi.observeText(t,a,n,e).observe(t,{childList:!0,subtree:!0})}}}),[...e.attributes].forEach(function(t){if(t.name.startsWith("golgi:on_")){let o=t.name.split("golgi:on_")[1],n=t.value;if(a[n]&&"function"==typeof a[n]){let t;t="AsyncFunction"===a[n].constructor.name?async function(e){await a[n](e)}:function(e){a[n](e)},golgi.addHandler.call(a,t,e,o)}e.removeAttribute(t.name)}if(t.value.includes("golgi:bind")){let o,n=t.value.split("golgi:bind=")[1];n=n.split(";")[0],o="INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName||"value"!==t.name?function(o){let i=o;"object"==typeof o&&(i=o[n]),void 0!==i&&e.setAttribute(t.name,i)}:function(t){let o=t;"object"==typeof t&&(o=t[n]),void 0!==o&&(e.value=o)},a.databinding.push(o),e.removeAttribute(t.name)}if(t.value.includes("golgi:observer")){let o=t.value.split("golgi:observer=")[1];o=o.split(";")[0],golgi.observeAttr(t.name,o).observe(e,{attributeFilter:[t.name],attributeOldValue:!0})}})}),a.childrenTarget||(a.childrenTarget=a.rootElement),a.childrenTarget.ownerComponent=a;let e="golgi:component-class",t=a.rootElement.getAttribute(e);if(t){t.split(" ").forEach(function(e){a.classList.add(e)}),a.rootElement.removeAttribute(e)}}if(a.componentName=e.componentName,a.getParentComponent=this.getParentComponent.bind(a),a.onUnload=this.onUnload.bind(a),a.registerUnloadMethod=this.registerUnloadMethod.bind(a),a.remove=this.remove.bind(a),a.removeAllByName=this.removeAllByName,a.getComponentByName=this.getComponentByName.bind(this),a.addHandler=this.addHandler.bind(a),a.addMetaTag=this.addMetaTag,a.loadResources=this.loadResources,a.loadJSAsync=this.loadJSAsync,a.loadJS=this.loadJS.bind(this),a.loadCSSAsync=this.loadCSSAsync,a.loadCSS=this.loadCSS.bind(this),a.logging=this.logging,a.logMessage=this.logMessage.bind(this),a.loadGroup=this.loadGroup.bind(this),a.renderAssembly=this.renderAssembly.bind(this),a.renderComponent=this.renderComponent.bind(this),a.renderComponentMap=this.renderComponentMap.bind(this),a.observerStart=this.observerStart,a.methodsToRemove=[],a.golgi_state=this.golgi_state,a.addStateMap=this.addStateMap.bind(a),a.applyDataBinding=this.applyDataBinding.bind(a),a.registeredListenerTypes=new Map,a.on=this.el_on.bind(a),a.off=this.el_off.bind(a),a.emit=this.el_emit.bind(a),a.onAssemblyRendered=function(e,t){golgi.on(e+"_rendered",t,a)},a.ownerAssembly=i,a.onOwnerAssemblyRendered=function(e){golgi.on(i+"_rendered",e,a)},o.rootComponent||(o.rootComponent=a),a.rootComponent=o.rootComponent,t&&(a.parentComponent=t.ownerComponent),this.logging&&(this.logMessage("Golgi Component instantiated and ready for use:"),console.log(a)),a.onBeforeState&&("AsyncFunction"===a.onBeforeState.constructor.name?await a.onBeforeState():a.onBeforeState()),e.state){for(let t in e.state)a[t]&&"function"==typeof a[t]&&(a[t].call(a,e.state[t]),delete e.state[t]);e.state&&a.setState&&"function"==typeof a.setState&&a.setState(e.state)}if(e.stateMap){e.state_map=new Map;for(let t in e.stateMap)e.state_map.set(t,e.stateMap[t])}if(e.state_map&&e.state_map.forEach(function(e,t){golgi.stateMap.has(t)||golgi.stateMap.set(t,[]),golgi.stateMap.get(t).push({component:a,method:e})}),a.onBeforeHooks&&a.onBeforeHooks(),e.hook)try{"AsyncFunction"===e.hook.constructor.name?await e.hook.call(a,o):e.hook.call(a,o)}catch(t){this.logging&&(this.logMessage("Unable to execute hook "+name+" for "+e.componentName),console.log(t))}return a.onAfterHooks&&a.onAfterHooks(),a.emit("componentReady"),a},renderComponentMap:async function(e,t,o,n,i,a){let s=-1,l=i.split(":"),r=l[0],g=l[1];void 0!==g&&""!==g||(g="applyDataBinding");for(let i of n){let n=await this.renderComponent(e,t,o);a&&a.call(n,n,i);let l=r+"."+ ++s;n.addStateMap(l,g)}this.golgi_state[r]=n},renderAssembly:async function(e,t,o){let n;if(t||o||"object"!=typeof e?n=e:(t=e.targetElement,o=e.context,n=e.name),!o)return;if(!n)return;if(""===n)return;let i,a=o.assemblyPath;""===a&&(a="./"),"/"!==a.slice(-1)&&(a+="/");let s=(i=this.assemblies.has(n)?{load:this.assemblies.get(n)}:await import(a+n+".js")).load.call(this,o),l=s.gjson||{};s.gx&&(l=this.parse(s.gx,s.hooks,o)),l&&(Array.isArray(l)||(l=[l]),l.forEach(function(e,t){l[t].assemblyName=n})),await this.loadGroup(l,t,o),this.emit(n+"_rendered")},async renderComponent(e,t,o){"body"===t&&(t=document.getElementsByTagName("body")[0]);let n=0;t&&(n=t.getElementsByTagName(e).length);let i=[{componentName:e}];return await this.loadGroup(i,t,o),t?t.getElementsByTagName(e)[n]:golgi.components},getParentComponent(e){"string"==typeof(e=e||{})&&(e={match:e}),this.element&&(this.tagName=this.element.tagName,this.parentNode=this.element.parentNode);let t=e.prefix||this.tagName.split("-")[0];return function o(n){if(!(n=11===n.nodeType?n.host:n.parentNode))return null;if(e.match){if(n.tagName===e.match.toUpperCase())return n}else if(n.tagName.startsWith(t))return n;return o(n)}(this)},getComponentByName(e,t,o){let n,i=[...(o=o||document).getElementsByTagName(e.toUpperCase())];if(!t)return i;for(n=0;n<i.length;n++)if(i[n].name===t)return i[n]},addHandler:function(e,t,o){o||"string"!=typeof t||(o=t,t=null),o=o||"click",(t=t||this.rootElement).addEventListener(o,e),this.listeners||(this.listeners=[]),this.listeners.push({type:o,fn:e,target:t})},registerUnloadMethod(e){this.methodsToRemove.push(e)},onUnload:function(){this.logging&&(this.logMessage("removing Golgi COmponent:"),console.log(this));for(const e of this.registeredListenerTypes.keys())this.logMessage("removing customHandler for type "+e),this.off(e);let e=this;this.listeners&&this.listeners.forEach(function(t){e.logging&&(e.logMessage("removing listener"),console.log(t)),t.target.removeEventListener(t.type,t.fn)}),this.methodsToRemove.forEach(function(t){e.logging&&(e.logMessage("invoking custom unload method"),console.log(t)),t()})},remove:function(){!function e(t){[...t.childNodes].forEach(function(t){1===t.nodeType&&(t.shadowRoot&&(t=t.shadowRoot),e(t),t.isComponent&&(t.onUnload(),t.parentNode.removeChild(t)))})}(this),this.onUnload(),this.parentNode.removeChild(this)},removeAllByName:function(e,t){let o;(o=t?[...t.getElementsByTagName(e)]:[...document.getElementsByTagName(e)])&&o.forEach(e=>{e.remove()})},el_on:function(e,t){if(!this.registeredListenerTypes.has(e)){let o=function(e){t(e.detail)};this.addEventListener(e,o),this.registeredListenerTypes.set(e,o)}},el_emit:function(e,t){if(this.registeredListenerTypes.has(e)){let o=new CustomEvent(e,{detail:t});this.dispatchEvent(o)}},el_off:function(e){if(this.registeredListenerTypes.has(e)){let t=this.registeredListenerTypes.get(e);this.removeEventListener(e,t),this.registeredListenerTypes.delete(e)}},on:function(e,t,o){if(!this.listeners.has(e)){let n={handler:t,context:o};this.listeners.set(e,n)}},off:function(e){this.listeners.has(e)&&this.listeners.delete(e)},emit:function(e,t){if(this.listeners.has(e)){let o=this.listeners.get(e),n=o.context||this;o.handler.call(n,t)}},logMessage:function(e){this.logging&&console.log(Date.now()+": "+e)},parse:function(e,t,o){let n='<xml xmlns="http://mgateway.com" xmlns:assembly="http://mgateway.com" xmlns:golgi="http://mgateway.com">'+e+"</xml>",i=[];return function e(n,i){[...n.childNodes].forEach(function(a){if(1===a.nodeType){if(["script","css","meta"].includes(a.tagName))return;let s={componentName:a.tagName,state:{}};if(a.tagName.includes("-")&&""!==a.textContent.trim()){let e=[...a.childNodes];for(let t=0;t<e.length;t++){let o=e[t];if(3===o.nodeType){let e=o.textContent.trim();if(""!==e){s.state.textContent=e;break}}}}if(a.hasAttributes())if(a.tagName.includes("-")||a.tagName.includes(":")){let e=[...a.attributes],i={};e.forEach(function(e){let l=e.value;if("true"===l)l=!0;else if("false"===l)l=!1;else if(l.startsWith&&l.startsWith("golgi:context=")){let e=l.split("golgi:context=")[1].split("."),t=o,n=!1;e.forEach(function(e,o){n||(void 0!==t[e]?t=t[e]:n=!0)}),l=n?"*Invalid context reference*":t}else try{l=JSON.parse(l)}catch(e){}if("golgi:hook"===e.name&&t&&t[a.tagName]&&t[a.tagName][l]&&(s.hook=t[a.tagName][l]),"golgi:stateMap"===e.name){let e=l.split(":")[0];s.state_map||(s.state_map=new Map);let t=l.split(":")[1];void 0!==t&&""!==t||(t="applyDataBinding"),s.state_map.set(e,t)}else if("golgi:appendTo"===e.name)s.targetElement={componentName:n.tagName,target:l};else if(e.name.includes(".")){let t=e.name.split("."),o=t.length,n=i;t.forEach(function(e,t){n[e]||(n[e]={}),t===o-1?n[e]=l:n=n[e]})}else s.state[e.name]=l});for(let e in i)s.state[e]=i[e]}else s.attributes={},[...a.attributes].forEach(function(e){"golgi:appendTo"===e.name?s.targetElement={componentName:n.tagName,target:e.value}:"golgi:hook"===e.name&&t&&t[a.tagName]&&t[a.tagName][e.value]?s.hook=t[a.tagName][e.value]:s.attributes[e.name]=e.value});a.tagName.includes("-")||0!==a.childElementCount||(s.textContent=a.textContent,s.childElementCount=a.childElementCount),a.hasChildNodes()&&(s.children=[],[...a.childNodes].forEach(function(e){if(1===e.nodeType&&["script","css","meta"].includes(e.tagName)){s[e.tagName]||(s[e.tagName]=[]);let t={};[...e.attributes].forEach(function(e){t[e.name]=e.value}),s[e.tagName].push(t)}}),e(a,s.children)),i.push(s)}})}((new DOMParser).parseFromString(n,"text/xml").documentElement,i),i},observerStart(){if(this.logging&&(this.logMessage("running observerStart on this:"),console.log(this)),this.observerCallback){let e=this.shadowRoot||this;golgi.observer.observe(e,{attributes:!0,attributeOldValue:!0,characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0})}},observer:new MutationObserver(function(e){e.forEach(function(e){let t=function(e){let t=!1,o=e;do{11===(o=o.parentNode).nodeType&&(o=o.host),o&&!o.tagName.includes("-")||(t=!0)}while(!t);return o}(e.target);t.observerCallback&&t.observerCallback(e)})}),observeAttr:(e,t)=>new MutationObserver(function(o){o.forEach(function(o){if("attributes"===o.type){let n=o.target.getAttribute(e),i=o.target.ownerComponent[t];i&&o.target.ownerComponent&&n&&n!==o.oldValue&&i.call(o.target.ownerComponent,n,o.oldValue)}})}),observeText:(e,t,o,n)=>new MutationObserver(function(i){i.forEach(function(i){if("childList"===i.type){let i=e.textContent,a=t[o];a&&i&&a.call(t,i,e,n)}})}),addStateMap(e,t){t=t||"applyDataBinding",golgi.stateMap.has(e)||golgi.stateMap.set(e,[]),golgi.stateMap.get(e).push({component:this,method:t})},applyDataBinding(e){this.databinding.forEach(function(t){t(e)}),this.onDataUpdated&&this.onDataUpdated(e)}};golgi.golgi_state=new Proxy(golgi.dataStore,{get:function(e,t,o){return setTimeout(function(){!function(e,t){if(golgi.logging&&(golgi.logMessage("1 trying to apply state for mapKey "+e+":"),console.log(t)),golgi.stateMap.has(e)){let o=golgi.stateMap.get(e);o.forEach((e,n)=>{if(e.component)if(e.component[e.method])e.component[e.method](t);else{let o={};o[e.method]=t,e.component.setState(o)}else o.splice(n,1)})}}(t,e[t])},100),e[t]},set:function(e,t,o){let n=[];function i(e,t){if(golgi.logging&&(golgi.logMessage("2 trying to apply state for mapKey "+e+":"),console.log(t)),golgi.stateMap.has(e)){let o=golgi.stateMap.get(e);o.forEach((e,n)=>{if(e.component)if(e.component[e.method])e.component[e.method](t);else{let o={};o[e.method]=t,e.component.setState(o)}else o.splice(n,1)})}}return golgi.dataStore[t]=o,"object"==typeof o&&function e(t,o){golgi.logging&&(golgi.logMessage("getProps called for "+t),console.log(o)),n.push(t),i(n.join("."),o),Object.entries(o).forEach((t,o)=>{const[a,s]=t;"object"!=typeof s?i(n.join(".")+"."+a,s):(e(a,s),n.pop())})}(t,o),"string"!=typeof o&&"number"!=typeof o||i(t,o),!0}});export{golgi};