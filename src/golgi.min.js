let log=!1,count=0,golgi={assemblies:new Map,dataStore:{},stateMap:new Map,componentHooks:new Map,prepareAssembly:function(e,t){if(e&&t){if(t.hooks){this.componentHooks.set(e,new Map);for(let o in t.hooks){let n=this.componentHooks.get(e);n.has(o)||n.set(o,new Map);let a=n.get(o);for(let e in t.hooks[o])a.set(e,t.hooks[o][e])}}t.component&&(Array.isArray(t.component)||(t.component=[t.component]),t.component[0].assemblyName=e,this.assemblies.set(e,t.component))}},setLog:function(e){log=e},loadResources:async function(e){let t=this,o=e.css;if(o){Array.isArray(o)||(o=[o]);for(let e of o)"object"!=typeof e?t.loadCSS(e):e.await?await t.loadCSSAsync(e.path,e.args):t.loadCSS(e.path,e.args)}let n=e.js;if(n){Array.isArray(n)||(n=[n]);for(let e of n)if("object"!=typeof e)t.loadJS(e);else if(e.await){await t.loadJSAsync(e.path,e.args)}else t.loadJS(e.path,e.args)}},loadJSAsync:async function(e,t){return await golgi.loadJSFilePromise(e,t)},loadJSFilePromise:async function(e,t){let o=this;return new Promise(n=>{o.loadJS(e,t,function(e){n(e)})})},loadJS:function(e,t,o){let n;t&&(o||"function"!=typeof t?"object"==typeof t&&(n=t.crossorigin):o=t);let a=document.createElement("script");a.type="text/javascript",a.src=e,a.onload=function(){log&&console.log("script "+e+" loaded"),o&&o(e)},n&&a.setAttribute("crossorigin",n),document.body.appendChild(a)},loadCSSAsync:async function(e,t){return await golgi.loadCSSPromise(e,t)},loadCSSPromise:async function(e,t){let o=this;return new Promise(n=>{o.loadCSS(e,t,function(e){n(e)})})},loadCSS:function(e,t,o){let n;t&&(o||"function"!=typeof t?"object"==typeof t&&(n=t.crossorigin,(t=t.target)||(t=document.getElementsByTagName("head")[0])):(o=t,t=document.getElementsByTagName("head")[0])),t||(t=document.getElementsByTagName("head")[0]);let a=t,s=document.createElement("link");s.rel="stylesheet",s.setAttribute("type","text/css"),s.href=e,n&&s.setAttribute("crossorigin",n),s.onload=function(){log&&console.log("CSS file "+e+" loaded"),o&&o(e)},a.appendChild(s)},addMetaTag:function(e){let t,o=document.createElement("meta");for(t in e)o.setAttribute(t,e[t]);document.getElementsByTagName("head")[0].appendChild(o)},async importAssemblyModule(e){let t=await import(e);return t[Object.keys(t)[0]]},load:async function(e,t,o){let n=e.split("-")[0],a=this,s=o.componentPath||"./";o.componentPaths&&o.componentPaths[n]&&(s=o.componentPaths[n]);let l=s;function r(e){let n=new e;return t.appendChild(n),n.context=o,n.path=s,n.rootPath=l,n.isComponent=!0,n.setState&&n.setState({golgi:a}),n}"/"!==l.slice(-1)&&(l=s+"/");let i=customElements.get(e);if(i){return log&&console.log("** component "+e+" already imported"),r(i)}{let o=await import(s+e+".js"),n=customElements.get(e);if(n||(o.load.call(this),n=customElements.get(e),log&&console.log("** component "+e+" had to be imported")),t){return r(n)}return}},loadGroup:async function(e,t,o){"body"===t&&(t=document.getElementsByTagName("body")[0]),o=o||{},Array.isArray(e)||(e=[e]);let n=e[0].assemblyName,a=this,s=e.length;await async function l(r){if(r===s)return;let i=Object.assign({},e[r]),c=t;if(i.targetElement){let e=a.getParentComponent.call(c,i.targetElement.componentName);e[i.targetElement.target]&&(c=e[i.targetElement.target])}if(i.componentName){if("function"==typeof i.if&&!i.if(o))return void await l(r+1);if(!i.componentName.includes("-")){let e=document.createElement(i.componentName);e.textContent=i.textContent;for(let t in i.attributes)e.setAttribute(t,i.attributes[t]);return e.childrenTarget=e,c.appendChild(e),void(i.children&&i.children[0]&&e.childrenTarget?(n&&(i.children[0].assemblyName=n),await a.loadGroup(i.children,e.childrenTarget,o),await l(r+1)):await l(r+1))}let e=await a.load(i.componentName,c,o);if(void 0!==e.html){e.innerHTML=e.html,e.rootElement=e.firstElementChild,e.querySelectorAll("*").forEach(function(t){if(t.hasAttribute("golgi-prop")){let o=t.getAttribute("golgi-prop");e[o]=t,t.removeAttribute("golgi-prop")}}),e.childrenTarget||(e.childrenTarget=e.rootElement);let t="golgi-component-class",o=e.rootElement.getAttribute(t);o&&(o.split(" ").forEach(function(t){e.classList.add(t)}),e.rootElement.removeAttribute(t))}if(e.getParentComponent=a.getParentComponent.bind(e),e.onUnload=a.onUnload.bind(e),e.registerUnloadMethod=a.registerUnloadMethod.bind(e),e.remove=a.remove.bind(e),e.getComponentByName=a.getComponentByName.bind(a),e.addHandler=a.addHandler.bind(e),e.addMetaTag=a.addMetaTag,e.loadResources=a.loadResources,e.loadJSAsync=a.loadJSAsync,e.loadJS=a.loadJS,e.loadCSSAsync=a.loadCSSAsync,e.loadCSS=a.loadCSS,e.loadGroup=a.loadGroup.bind(a),e.renderAssembly=a.renderAssembly.bind(a),e.renderComponent=a.renderComponent.bind(a),e.observerStart=a.observerStart,e.importAssemblyModule=a.importAssemblyModule,e.methodsToRemove=[],e.assemblies=a.assemblies,log&&(console.log("Golgi Component instantiated and ready for use:"),console.log(e)),e.onBeforeState&&("AsyncFunction"===e.onBeforeState.constructor.name?await e.onBeforeState():e.onBeforeState()),i.state&&e.setState){for(let t in i.state)"function"==typeof i.state[t]&&(i.state[t]=i.state[t].call(e));e.setState(i.state)}if(i.stateMap){i.state_map=new Map;for(let e in i.stateMap)i.state_map.set(e,i.stateMap[e])}i.state_map&&i.state_map.forEach(function(t,o){a.stateMap.has(o)||a.stateMap.set(o,[]),a.stateMap.get(o).push({component:e,method:t})}),e.onBeforeHooks&&e.onBeforeHooks();let t=a.componentHooks.get(n);i.hooks&&t&&i.hooks.forEach(function(o){if(t.has(i.componentName)){let n=t.get(i.componentName);if(n.has(o))try{n.get(o).call(e,i.state)}catch(e){log&&(console.log("Unable to execute hook "+name+" for "+i.componentName),console.log(e))}}}),e.onAfterHooks&&e.onAfterHooks(),i.children&&i.children[0]&&e.childrenTarget?(n&&(i.children[0].assemblyName=n),await a.loadGroup(i.children,e.childrenTarget,o),await l(r+1)):await l(r+1)}}(0)},renderAssembly:async function(e,t,o,n){let a;if(t||o||"object"!=typeof e?a=e:(t=e.targetElement,o=e.context,n=e.load_args,a=e.name),(n=n||{}).golgi=this,!t)return;if(!o)return;if(!a)return;if(""===a)return;if(!this.assemblies.has(a)){let e=o.assemblyPath;""===e&&(e="./"),"/"!==e.slice(-1)&&(e+="/");let t=(await import(e+a+".js")).load(n),s=t.json||{};t.gx&&(s=this.parse(t.gx));let l={component:s,hooks:t.hooks};this.prepareAssembly(a,l)}let s=this.assemblies.get(a);return await this.loadGroup(s,t,o)},async renderComponent(e,t,o){"body"===t&&(t=document.getElementsByTagName("body")[0]);let n=t.getElementsByTagName(e).length,a=[{componentName:e}];return this.componentHooks.has(e)||this.componentHooks.set(e,new Map),await this.loadGroup(a,t,o),t.getElementsByTagName(e)[n]},getParentComponent(e){"string"==typeof(e=e||{})&&(e={match:e});let t=e.prefix||this.tagName.split("-")[0];return function o(n){if(!(n=n.parentNode))return null;if(e.match){if(n.tagName===e.match.toUpperCase())return n}else if(n.tagName.startsWith(t))return n;return o(n)}(this)},getComponentByName(e,t,o){let n,a=[...(o=o||document).getElementsByTagName(e)];for(n=0;n<a.length;n++)if(a[n].name===t)return a[n]},addHandler:function(e,t,o){o||"string"!=typeof t||(o=t,t=null),o=o||"click",(t=t||this.rootElement).addEventListener(o,e),this.listeners||(this.listeners=[]),this.listeners.push({type:o,fn:e,target:t})},registerUnloadMethod(e){this.methodsToRemove.push(e)},onUnload:function(){log&&(console.log("removing Golgi COmponent:"),console.log(this)),this.listeners&&this.listeners.forEach(function(e){log&&(console.log("removing listener"),console.log(e)),e.target.removeEventListener(e.type,e.fn)}),this.methodsToRemove.forEach(function(e){log&&(console.log("invoking custom unload method"),console.log(e)),e()})},remove:function(){!function e(t){[...t.childNodes].forEach(function(t){1===t.nodeType&&(e(t),t.isComponent&&(t.onUnload(),t.parentNode.removeChild(t)))})}(this),this.onUnload(),this.parentNode.removeChild(this)},parse:function(e){let t="<xml>"+e+"</xml>",o=[];return function e(t,o){[...t.childNodes].forEach(function(n){if(1===n.nodeType){let a={componentName:n.tagName};if(n.hasAttributes())if(n.tagName.includes("-")){a.state={};let e=[...n.attributes],o={};e.forEach(function(e){let n=e.value;if("true"===n)n=!0;else if("false"===n)n=!1;else try{n=JSON.parse(n)}catch(e){}if("golgi-hook"===e.name)a.hooks=[n];else if("golgi-stateMap"===e.name){let e=n.split(":")[0];a.state_map||(a.state_map=new Map),a.state_map.set(e,n.split(":")[1])}else if("golgi-appendTo"===e.name)a.targetElement={componentName:t.tagName,target:n};else if(e.name.includes(".")){let t=e.name.split("."),a=t.length,s=o;t.forEach(function(e,t){s[e]||(s[e]={}),t===a-1?s[e]=n:s=s[e]})}else a.state[e.name]=n});for(let e in o)a.state[e]=o[e]}else a.attributes={},[...n.attributes].forEach(function(e){a.attributes[e.name]=e.value});n.tagName.includes("-")||0!==n.childElementCount||(a.textContent=n.textContent,a.childElementCount=n.childElementCount),n.hasChildNodes()&&(a.children=[],e(n,a.children)),o.push(a)}})}((new DOMParser).parseFromString(t,"text/xml").documentElement,o),o},observerStart(){console.log("running observerStart on this:"),console.log(this),this.observerCallback&&golgi.observer.observe(this,{attributes:!0,attributeOldValue:!0,characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0})},observer:new MutationObserver(function(e){e.forEach(function(e){let t=function(e){let t=!1,o=e;do{(o=o.parentElement)&&!o.tagName.includes("-")||(t=!0)}while(!t);return o}(e.target);t.observerCallback&&t.observerCallback(e)})}),state:new Proxy({},{set:function(e,t,o){let n=[];function a(e,t){golgi.stateMap.has(e)&&golgi.stateMap.get(e).forEach(e=>{let o={};o[e.method]=t,e.component.setState(o)})}return golgi.dataStore[t]=o,"object"==typeof o&&function e(t,o){console.log("getProps called for "+t),console.log(o),n.push(t),a(n.join("."),o),Object.entries(o).forEach((t,o)=>{const[s,l]=t;"object"!=typeof l?a(n.join(".")+"."+s,l):(e(s,l),n.pop())})}(t,o),"string"==typeof o&&a(t,o),!0}})};export{golgi};