let count=0,golgi={dataStore:{},components:[],assemblies:new Map,stateMap:new Map,resourceLoaded:new Map,listeners:new Map,logging:!1,version:"1.3.4",setLog:function(e){this.logging=e},loadJSAsync:async function(e,t){return await golgi.loadJSFilePromise(e,t)},loadJSFilePromise:async function(e,t){let o=this;return new Promise(n=>{o.loadJS(e,t,function(e){n(e)})})},loadJS:function(e,t,o){let n;t&&(o||"function"!=typeof t?"object"==typeof t&&(n=t.crossorigin):o=t);let s=document.createElement("script");s.type="text/javascript",s.src=e;let i=this;s.onload=function(){i.logMessage("script "+e+" loaded"),o&&o(e)},n&&s.setAttribute("crossorigin",n),document.body.appendChild(s)},loadCSSAsync:async function(e,t){return await golgi.loadCSSPromise(e,t)},loadCSSPromise:async function(e,t){let o=this;return new Promise(n=>{o.loadCSS(e,t,function(e){n(e)})})},loadCSS:function(e,t,o){let n;t&&(o||"function"!=typeof t?"object"==typeof t&&(n=t.crossorigin,(t=t.target)||(t=document.getElementsByTagName("head")[0])):(o=t,t=document.getElementsByTagName("head")[0])),t||(t=document.getElementsByTagName("head")[0]);let s=t,i=document.createElement("link");i.rel="stylesheet",i.setAttribute("type","text/css"),i.href=e,n&&i.setAttribute("crossorigin",n);let a=this;i.onload=function(){a.logMessage("CSS file "+e+" loaded"),o&&o(e)},s.appendChild(i)},addMetaTag:function(e){let t,o=document.createElement("meta");for(t in e)o.setAttribute(t,e[t]);document.getElementsByTagName("head")[0].appendChild(o)},fetch_optimised_components:async function(e,t){let o=t.componentPaths[e]+"golgi-components.js";this.logMessage("fetching optimised file of all components: "+o);try{const{golgi_components:t}=await import(o);t.forEach(function(e){e()})}catch(t){this.logMessage("Unable to fetch optimised component module for "+e)}},fetch_optimised_assemblies:async function(e){let t=e.assemblyPath+"golgi-assemblies.js";this.logMessage("fetching optimised file of all assemblies: "+t);let o=this;try{const{golgi_assemblies:e}=await import(t);e.forEach(function(e){o.assemblies.set(e.name,e.code)})}catch(e){this.logMessage("Unable to fetch optimised assembly module")}this.emit("assembliesLoaded")},prefetchAssemblies:function(e,t){e.forEach(function(e){golgi.prefetchAssembly(e,t)})},prefetchAssembly:async function(e,t){let o,n=t.assemblyPath;""===n&&(n="./"),"/"!==n.slice(-1)&&(n+="/");let s=(o=this.assemblies.has(e)?{load:this.assemblies.get(e)}:await import(n+e+".js")).load.call(this,t),i=s.gjson||{};s.gx&&(i=this.parse(s.gx,s.hooks)),i&&(Array.isArray(i)||(i=[i]),i.forEach(function(t,o){i[o].assemblyName=e})),this.preloadAssembly(i,t)},preloadComponent:async function(e,t){let o=e.componentName;if("assembly"!==o.split(":")[0]){if(o.includes("-"))this.preload(o,t);else if("script"===o){if(!golgi.resourceLoaded.has(e.src)){let t;e.crossorigin&&(t={crossorigin:e.crossorigin}),golgi.loadJS(e.src,t),golgi.resourceLoaded.set(e.src,!0)}}else if("css"===o&&!golgi.resourceLoaded.has(e.src)){let t;e.crossorigin&&(t={crossorigin:e.crossorigin}),golgi.loadCSS(e.src,t),golgi.resourceLoaded.set(e.src,!0)}e.children&&e.children[0]&&this.preloadAssembly(e.children,t)}else{let e=o.split("assembly:")[1];this.prefetchAssembly(e,t)}},preloadAssembly:function(e,t){for(const o of e)this.preloadComponent(o,t)},preloadComponents:function(e,t){e.forEach(function(e){golgi.preload(e,t)})},preload:async function(e,t){let o=e.split("-")[0];this.logMessage("*** preload "+e);let n=t.componentPath||"./";t.componentPaths&&t.componentPaths[o]&&(n=t.componentPaths[o]);let s=n;if("/"!==s.slice(-1)&&(s=n+"/"),!customElements.get(e)){let t=await import(n+e+".js"),o=customElements.get(e);o?this.logMessage("** preload: component "+e+" loaded by another loop"):(t.load.call(this),o=customElements.get(e),this.logMessage("** preload: component "+e+" had to be imported"))}},load:async function(e,t,o){let n=e.split("-")[0];this.logMessage("*** load "+e);let s=o.componentPath||"./";o.componentPaths&&o.componentPaths[n]&&(s=o.componentPaths[n]);let i=s;function a(e){let n=new e;return t?t.appendChild(n):golgi.components.push(n),n.context=o,n.path=s,n.rootPath=i,n.isComponent=!0,n}"/"!==i.slice(-1)&&(i=s+"/");let l=customElements.get(e);if(l){return this.logMessage("** component "+e+" already imported"),a(l)}{let t=await import(s+e+".js"),o=customElements.get(e);return o||(t.load.call(this),o=customElements.get(e),this.logMessage("** component "+e+" had to be imported")),a(o)}},loadGroup:async function(e,t,o){"body"===t&&(t=document.getElementsByTagName("body")[0]),o=o||{},Array.isArray(e)||(e=[e]);let n=e[0].assemblyName;for(const s of e)await this.processComponent(s,n,t,o)},processComponent:async function(e,t,o,n){let s=o;if(e.targetElement){let t=this.getParentComponent.call(s,e.targetElement.componentName);t&&t[e.targetElement.target]&&(s=t[e.targetElement.target])}if("assembly"===e.componentName.split(":")[0]){let t=e.componentName.split("assembly:")[1];if(await this.renderAssembly(t,s,n),e.hook)try{e.hook.call(this)}catch(e){this.logging&&(this.logMessage("Unable to execute hook "+name+" for "+config.componentName),console.log(e))}return}let i=await this.loadComponent(e,t,s,n);e.children&&e.children[0]&&i.childrenTarget&&(e.children.forEach(function(o,n){e.children[n].assemblyName=t}),await this.loadGroup(e.children,i.childrenTarget,n))},loadComponent:async function(e,t,o,n){let s=Object.assign({},e);if(!s.componentName.includes("-")&&!s.componentName.includes(":")){let e=document.createElement(s.componentName);e.textContent=s.textContent;for(let t in s.attributes)e.setAttribute(t,s.attributes[t]);if(e.childrenTarget=e,o&&o.appendChild(e),s.hook)try{let t={...this};t.element=e,"AsyncFunction"===s.hook.constructor.name?await s.hook.call(t):s.hook.call(t)}catch(e){this.logging&&(this.logMessage("Unable to execute hook "+name+" for "+s.componentName),console.log(e))}return e}s.meta&&s.meta.forEach(function(e){golgi.addMetaTag(e)});await Promise.all(["script","css"].map(async e=>{"script"===e&&s.script&&await Promise.all(s.script.map(async e=>{if(!golgi.resourceLoaded.has(e.src)){let t;e.crossorigin&&(t={crossorigin:e.crossorigin}),e.await?await golgi.loadJSAsync(e.src,t):golgi.loadJS(e.src,t),golgi.resourceLoaded.set(e.src,!0)}})),"css"===e&&s.css&&await Promise.all(s.css.map(async e=>{if(!golgi.resourceLoaded.has(e.src)){let t;e.crossorigin&&(t={crossorigin:e.crossorigin}),e.await?await golgi.loadCSSAsync(e.src,t):golgi.loadCSS(e.src,t),golgi.resourceLoaded.set(e.src,!0)}}))}));let i=await this.renderWebComponent(s,o,n);return i.parentComponent&&i.parentComponent.onChildComponentReady&&i.parentComponent.onChildComponentReady.call(i.parentComponent,i),i},renderWebComponent:async function(e,t,o){let n,s=e.assemblyName,i=await this.load(e.componentName,t,o);if(this.logging,i.shadowRoot){if(i.rootElement=i.shadowRoot.firstElementChild,"STYLE"===i.rootElement.tagName){let e=!1,t=i.rootElement;do{t.nextSibling&&1===(t=t.nextSibling).nodeType&&(e=!0)}while(!e);i.rootElement=e?t:i.shadowRoot.firstElementChild}n=i.shadowRoot.querySelectorAll("*")}else void 0!==i.html&&(i.innerHTML=i.html,i.rootElement=i.firstElementChild,n=i.querySelectorAll("*"));if(void 0!==i.rootElement){i.databinding=[],n.forEach(function(e){if(e.hasAttribute("golgi:prop")){let t=e.getAttribute("golgi:prop");i[t]=e,e.removeAttribute("golgi:prop")}e.ownerComponent=i,e.childNodes.forEach(function(t){if(3===t.nodeType){let o=t.nodeValue.toString();if(t.nodeValue.includes("golgi:bind")){let o=t.nodeValue.split("golgi:bind=")[1]||"dummy";o=o.split(";")[0];let n=document.createElement("span");e.insertBefore(n,t);let s=function(e){let t=e;"object"==typeof e&&(t=e[o]),n.innerHTML=t};i.databinding.push(s),t.nodeValue=""}if(o.includes("golgi:observer")){let t=e;e.firstChild&&"SPAN"===e.firstChild.tagName&&(t=e.firstChild);let n=o.split("golgi:observer=")[1];n=n.split(";")[0],golgi.observeText(t,i,n,e).observe(t,{childList:!0,subtree:!0})}}}),[...e.attributes].forEach(function(t){if(t.name.startsWith("golgi:on_")){let o=t.name.split("golgi:on_")[1],n=t.value;if(i[n]&&"function"==typeof i[n]){let t;t="AsyncFunction"===i[n].constructor.name?async function(e){await i[n](e)}:function(e){i[n](e)},golgi.addHandler.call(i,t,e,o)}e.removeAttribute(t.name)}if(t.value.includes("golgi:bind")){let o,n=t.value.split("golgi:bind=")[1];n=n.split(";")[0],o="INPUT"===e.tagName||"TEXTAREA"===e.tagName&&"value"===t.name?function(t){let o=t;"object"==typeof t&&(o=t[n]),e.value=o}:function(o){let s=o;"object"==typeof o&&(s=o[n]),e.setAttribute(t.name,s)},i.databinding.push(o),e.removeAttribute(t.name)}if(t.value.includes("golgi:observer")){let o=t.value.split("golgi:observer=")[1];o=o.split(";")[0],golgi.observeAttr(t.name,o).observe(e,{attributeFilter:[t.name],attributeOldValue:!0})}})}),i.childrenTarget||(i.childrenTarget=i.rootElement),i.childrenTarget.ownerComponent=i;let e="golgi:component-class",t=i.rootElement.getAttribute(e);if(t){t.split(" ").forEach(function(e){i.classList.add(e)}),i.rootElement.removeAttribute(e)}}if(i.componentName=e.componentName,i.getParentComponent=this.getParentComponent.bind(i),i.onUnload=this.onUnload.bind(i),i.registerUnloadMethod=this.registerUnloadMethod.bind(i),i.remove=this.remove.bind(i),i.removeAllByName=this.removeAllByName,i.getComponentByName=this.getComponentByName.bind(this),i.addHandler=this.addHandler.bind(i),i.addMetaTag=this.addMetaTag,i.loadResources=this.loadResources,i.loadJSAsync=this.loadJSAsync,i.loadJS=this.loadJS.bind(this),i.loadCSSAsync=this.loadCSSAsync,i.loadCSS=this.loadCSS.bind(this),i.logging=this.logging,i.logMessage=this.logMessage.bind(this),i.loadGroup=this.loadGroup.bind(this),i.renderAssembly=this.renderAssembly.bind(this),i.renderComponent=this.renderComponent.bind(this),i.renderComponentMap=this.renderComponentMap.bind(this),i.observerStart=this.observerStart,i.methodsToRemove=[],i.golgi_state=this.golgi_state,i.addStateMap=this.addStateMap.bind(i),i.applyDataBinding=this.applyDataBinding.bind(i),i.registeredListenerTypes=new Map,i.on=this.el_on.bind(i),i.off=this.el_off.bind(i),i.emit=this.el_emit.bind(i),i.onAssemblyRendered=function(e,t){golgi.on(e+"_rendered",t,i)},i.ownerAssembly=s,i.onOwnerAssemblyRendered=function(e){golgi.on(s+"_rendered",e,i)},o.rootComponent||(o.rootComponent=i),i.rootComponent=o.rootComponent,t&&(i.parentComponent=t.ownerComponent),this.logging&&(this.logMessage("Golgi Component instantiated and ready for use:"),console.log(i)),i.onBeforeState&&("AsyncFunction"===i.onBeforeState.constructor.name?await i.onBeforeState():i.onBeforeState()),e.state){for(let t in e.state)i[t]&&"function"==typeof i[t]&&(i[t].call(i,e.state[t]),delete e.state[t]);e.state&&i.setState&&"function"==typeof i.setState&&i.setState(e.state)}if(e.stateMap){e.state_map=new Map;for(let t in e.stateMap)e.state_map.set(t,e.stateMap[t])}if(e.state_map&&e.state_map.forEach(function(e,t){golgi.stateMap.has(t)||golgi.stateMap.set(t,[]),golgi.stateMap.get(t).push({component:i,method:e})}),i.onBeforeHooks&&i.onBeforeHooks(),e.hook)try{"AsyncFunction"===e.hook.constructor.name?await e.hook.call(i):e.hook.call(i)}catch(t){this.logging&&(this.logMessage("Unable to execute hook "+name+" for "+e.componentName),console.log(t))}return i.onAfterHooks&&i.onAfterHooks(),i.emit("componentReady"),i},renderComponentMap:async function(e,t,o,n,s,i){let a=-1,l=s.split(":"),r=l[0],c=l[1];void 0!==c&&""!==c||(c="applyDataBinding");for(let s of n){let n=await this.renderComponent(e,t,o);i&&i.call(n,n,s);let l=r+"."+ ++a;n.addStateMap(l,c)}this.golgi_state[r]=n},renderAssembly:async function(e,t,o){let n;if(t||o||"object"!=typeof e?n=e:(t=e.targetElement,o=e.context,n=e.name),!o)return;if(!n)return;if(""===n)return;let s,i=o.assemblyPath;""===i&&(i="./"),"/"!==i.slice(-1)&&(i+="/");let a=(s=this.assemblies.has(n)?{load:this.assemblies.get(n)}:await import(i+n+".js")).load.call(this,o),l=a.gjson||{};a.gx&&(l=this.parse(a.gx,a.hooks)),l&&(Array.isArray(l)||(l=[l]),l.forEach(function(e,t){l[t].assemblyName=n})),this.preloadAssembly(l,o),await this.loadGroup(l,t,o),this.emit(n+"_rendered")},async renderComponent(e,t,o){"body"===t&&(t=document.getElementsByTagName("body")[0]);let n=0;t&&(n=t.getElementsByTagName(e).length);let s=[{componentName:e}];return await this.loadGroup(s,t,o),t?t.getElementsByTagName(e)[n]:golgi.components},getParentComponent(e){"string"==typeof(e=e||{})&&(e={match:e}),this.element&&(this.tagName=this.element.tagName,this.parentNode=this.element.parentNode);let t=e.prefix||this.tagName.split("-")[0];return function o(n){if(!(n=11===n.nodeType?n.host:n.parentNode))return null;if(e.match){if(n.tagName===e.match.toUpperCase())return n}else if(n.tagName.startsWith(t))return n;return o(n)}(this)},getComponentByName(e,t,o){let n,s=[...(o=o||document).getElementsByTagName(e.toUpperCase())];if(!t)return s;for(n=0;n<s.length;n++)if(s[n].name===t)return s[n]},addHandler:function(e,t,o){o||"string"!=typeof t||(o=t,t=null),o=o||"click",(t=t||this.rootElement).addEventListener(o,e),this.listeners||(this.listeners=[]),this.listeners.push({type:o,fn:e,target:t})},registerUnloadMethod(e){this.methodsToRemove.push(e)},onUnload:function(){this.logging&&(this.logMessage("removing Golgi COmponent:"),console.log(this));for(const e of this.registeredListenerTypes.keys())this.logMessage("removing customHandler for type "+e),this.off(e);let e=this;this.listeners&&this.listeners.forEach(function(t){e.logging&&(e.logMessage("removing listener"),console.log(t)),t.target.removeEventListener(t.type,t.fn)}),this.methodsToRemove.forEach(function(t){e.logging&&(e.logMessage("invoking custom unload method"),console.log(t)),t()})},remove:function(){!function e(t){[...t.childNodes].forEach(function(t){1===t.nodeType&&(e(t),t.isComponent&&(t.onUnload(),t.parentNode.removeChild(t)))})}(this),this.onUnload(),this.parentNode.removeChild(this)},removeAllByName:function(e,t){let o;(o=t?[...t.getElementsByTagName(e)]:[...document.getElementsByTagName(e)])&&o.forEach(e=>{e.remove()})},el_on:function(e,t){if(!this.registeredListenerTypes.has(e)){let o=function(e){t(e.detail)};this.addEventListener(e,o),this.registeredListenerTypes.set(e,o)}},el_emit:function(e,t){if(this.registeredListenerTypes.has(e)){let o=new CustomEvent(e,{detail:t});this.dispatchEvent(o)}},el_off:function(e){if(this.registeredListenerTypes.has(e)){let t=this.registeredListenerTypes.get(e);this.removeEventListener(e,t),this.registeredListenerTypes.delete(e)}},on:function(e,t,o){if(!this.listeners.has(e)){let n={handler:t,context:o};this.listeners.set(e,n)}},off:function(e){this.listeners.has(e)&&this.listeners.delete(e)},emit:function(e,t){if(this.listeners.has(e)){let o=this.listeners.get(e),n=o.context||this;o.handler.call(n,t)}},logMessage:function(e){this.logging&&console.log(Date.now()+": "+e)},parse:function(e,t){let o='<xml xmlns="http://mgateway.com" xmlns:assembly="http://mgateway.com" xmlns:golgi="http://mgateway.com">'+e+"</xml>",n=[];return function e(o,n){[...o.childNodes].forEach(function(s){if(1===s.nodeType){if(["script","css","meta"].includes(s.tagName))return;let i={componentName:s.tagName,state:{}};if(s.tagName.includes("-")&&""!==s.textContent.trim()){let e=[...s.childNodes];for(let t=0;t<e.length;t++){let o=e[t];if(3===o.nodeType){let e=o.textContent.trim();if(""!==e){i.state.textContent=e;break}}}}if(s.hasAttributes())if(s.tagName.includes("-")||s.tagName.includes(":")){let e=[...s.attributes],n={};e.forEach(function(e){let a=e.value;if("true"===a)a=!0;else if("false"===a)a=!1;else try{a=JSON.parse(a)}catch(e){}if("golgi:hook"===e.name&&t&&t[s.tagName]&&t[s.tagName][a]&&(i.hook=t[s.tagName][a]),"golgi:stateMap"===e.name){let e=a.split(":")[0];i.state_map||(i.state_map=new Map);let t=a.split(":")[1];void 0!==t&&""!==t||(t="applyDataBinding"),i.state_map.set(e,t)}else if("golgi:appendTo"===e.name)i.targetElement={componentName:o.tagName,target:a};else if(e.name.includes(".")){let t=e.name.split("."),o=t.length,s=n;t.forEach(function(e,t){s[e]||(s[e]={}),t===o-1?s[e]=a:s=s[e]})}else i.state[e.name]=a});for(let e in n)i.state[e]=n[e]}else i.attributes={},[...s.attributes].forEach(function(e){"golgi:appendTo"===e.name?i.targetElement={componentName:o.tagName,target:e.value}:"golgi:hook"===e.name&&t&&t[s.tagName]&&t[s.tagName][e.value]?i.hook=t[s.tagName][e.value]:i.attributes[e.name]=e.value});s.tagName.includes("-")||0!==s.childElementCount||(i.textContent=s.textContent,i.childElementCount=s.childElementCount),s.hasChildNodes()&&(i.children=[],[...s.childNodes].forEach(function(e){if(1===e.nodeType&&["script","css","meta"].includes(e.tagName)){i[e.tagName]||(i[e.tagName]=[]);let t={};[...e.attributes].forEach(function(e){t[e.name]=e.value}),i[e.tagName].push(t)}}),e(s,i.children)),n.push(i)}})}((new DOMParser).parseFromString(o,"text/xml").documentElement,n),n},observerStart(){if(this.logging&&(this.logMessage("running observerStart on this:"),console.log(this)),this.observerCallback){let e=this.shadowRoot||this;golgi.observer.observe(e,{attributes:!0,attributeOldValue:!0,characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0})}},observer:new MutationObserver(function(e){e.forEach(function(e){let t=function(e){let t=!1,o=e;do{11===(o=o.parentNode).nodeType&&(o=o.host),o&&!o.tagName.includes("-")||(t=!0)}while(!t);return o}(e.target);t.observerCallback&&t.observerCallback(e)})}),observeAttr:(e,t)=>new MutationObserver(function(o){o.forEach(function(o){if("attributes"===o.type){let n=o.target.getAttribute(e),s=o.target.ownerComponent[t];s&&o.target.ownerComponent&&s.call(o.target.ownerComponent,n,o.oldValue)}})}),observeText:(e,t,o,n)=>new MutationObserver(function(s){s.forEach(function(s){if("childList"===s.type){let s=e.textContent,i=t[o];i&&i.call(t,s,e,n)}})}),addStateMap(e,t){t=t||"applyDataBinding",golgi.stateMap.has(e)||golgi.stateMap.set(e,[]),golgi.stateMap.get(e).push({component:this,method:t})},applyDataBinding(e){this.databinding.forEach(function(t){t(e)}),this.onDataUpdated&&this.onDataUpdated(e)}};golgi.golgi_state=new Proxy(golgi.dataStore,{get:function(e,t,o){return setTimeout(function(){!function(e,t){if(golgi.logging&&(golgi.logMessage("trying to apply state for mapKey "+e+" = "+t),console.log(golgi.stateMap)),golgi.stateMap.has(e)){let o=golgi.stateMap.get(e);o.forEach((e,n)=>{if(e.component)if(e.component[e.method])e.component[e.method](t);else{let o={};o[e.method]=t,e.component.setState(o)}else o.splice(n,1)})}}(t,e[t])},100),e[t]},set:function(e,t,o){let n=[];function s(e,t){if(golgi.logging&&(golgi.logMessage("trying to apply state for mapKey "+e+" = "+t),console.log(golgi.stateMap)),golgi.stateMap.has(e)){let o=golgi.stateMap.get(e);o.forEach((e,n)=>{if(e.component)if(e.component[e.method])e.component[e.method](t);else{let o={};o[e.method]=t,e.component.setState(o)}else o.splice(n,1)})}}return golgi.dataStore[t]=o,"object"==typeof o&&function e(t,o){golgi.logging&&(golgi.logMessage("getProps called for "+t),console.log(o)),n.push(t),s(n.join("."),o),Object.entries(o).forEach((t,o)=>{const[i,a]=t;"object"!=typeof a?s(n.join(".")+"."+i,a):(e(i,a),n.pop())})}(t,o),"string"!=typeof o&&"number"!=typeof o||s(t,o),!0}});export{golgi};