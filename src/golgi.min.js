let log=!1,count=0,golgi={dataStore:{},stateMap:new Map,resourceLoaded:new Map,setLog:function(e){log=e},loadJSAsync:async function(e,t){return await golgi.loadJSFilePromise(e,t)},loadJSFilePromise:async function(e,t){let o=this;return new Promise(n=>{o.loadJS(e,t,function(e){n(e)})})},loadJS:function(e,t,o){let n;t&&(o||"function"!=typeof t?"object"==typeof t&&(n=t.crossorigin):o=t);let a=document.createElement("script");a.type="text/javascript",a.src=e,a.onload=function(){log&&console.log("script "+e+" loaded"),o&&o(e)},n&&a.setAttribute("crossorigin",n),document.body.appendChild(a)},loadCSSAsync:async function(e,t){return await golgi.loadCSSPromise(e,t)},loadCSSPromise:async function(e,t){let o=this;return new Promise(n=>{o.loadCSS(e,t,function(e){n(e)})})},loadCSS:function(e,t,o){let n;t&&(o||"function"!=typeof t?"object"==typeof t&&(n=t.crossorigin,(t=t.target)||(t=document.getElementsByTagName("head")[0])):(o=t,t=document.getElementsByTagName("head")[0])),t||(t=document.getElementsByTagName("head")[0]);let a=t,s=document.createElement("link");s.rel="stylesheet",s.setAttribute("type","text/css"),s.href=e,n&&s.setAttribute("crossorigin",n),s.onload=function(){log&&console.log("CSS file "+e+" loaded"),o&&o(e)},a.appendChild(s)},addMetaTag:function(e){let t,o=document.createElement("meta");for(t in e)o.setAttribute(t,e[t]);document.getElementsByTagName("head")[0].appendChild(o)},load:async function(e,t,o){let n=e.split("-")[0];log&&console.log("*** load "+e);let a=this,s=o.componentPath||"./";o.componentPaths&&o.componentPaths[n]&&(s=o.componentPaths[n]);let l=s;function i(e){let n=new e;return t.appendChild(n),n.context=o,n.path=s,n.rootPath=l,n.isComponent=!0,n.setState&&n.setState({golgi:a}),n}"/"!==l.slice(-1)&&(l=s+"/");let r=customElements.get(e);if(r){return log&&console.log("** component "+e+" already imported"),i(r)}{let o=await import(s+e+".js"),n=customElements.get(e);if(n||(o.load.call(this),n=customElements.get(e),log&&console.log("** component "+e+" had to be imported")),t){return i(n)}return}},loadGroup:async function(e,t,o){"body"===(t=t||"body")&&(t=document.getElementsByTagName("body")[0]),o=o||{},Array.isArray(e)||(e=[e]);let n=e[0].assemblyName;for(const a of e)await this.processComponent(a,n,t,o)},processComponent:async function(e,t,o,n){let a=o;if(e.targetElement){let t=this.getParentComponent.call(a,e.targetElement.componentName);t&&t[e.targetElement.target]&&(a=t[e.targetElement.target])}if("assembly"===e.componentName.split(":")[0]){let t=e.componentName.split("assembly:")[1];if(await this.renderAssembly(t,a,n),e.hook)try{e.hook.call(this)}catch(e){log&&(console.log("Unable to execute hook "+name+" for "+config.componentName),console.log(e))}return}let s=await this.loadComponent(e,t,a,n);e.children&&e.children[0]&&s.childrenTarget&&(e.children.forEach(function(o,n){e.children[n].assemblyName=t}),this.loadGroup(e.children,s.childrenTarget,n))},loadComponent:async function(e,t,o,n){let a=Object.assign({},e);if(!a.componentName.includes("-")&&!a.componentName.includes(":")){let e=document.createElement(a.componentName);e.textContent=a.textContent;for(let t in a.attributes)e.setAttribute(t,a.attributes[t]);if(e.childrenTarget=e,o.appendChild(e),a.hook)try{a.hook.call(this)}catch(e){log&&(console.log("Unable to execute hook "+name+" for "+a.componentName),console.log(e))}return e}a.meta&&a.meta.forEach(function(e){golgi.addMetaTag(e)});return await Promise.all(["script","css"].map(async e=>{"script"===e&&a.script&&await Promise.all(a.script.map(async e=>{if(!golgi.resourceLoaded.has(e.src)){let t;e.crossorigin&&(t={crossorigin:e.crossorigin}),e.await?await golgi.loadJSAsync(e.src,t):golgi.loadJS(e.src,t),golgi.resourceLoaded.set(e.src,!0)}})),"css"===e&&a.css&&await Promise.all(a.css.map(async e=>{if(!golgi.resourceLoaded.has(e.src)){let t;e.crossorigin&&(t={crossorigin:e.crossorigin}),e.await?await golgi.loadCSSAsync(e.src,t):golgi.loadCSS(e.src,t),golgi.resourceLoaded.set(e.src,!0)}}))})),await this.renderWebComponent(a,o,n)},renderWebComponent:async function(e,t,o){let n=await this.load(e.componentName,t,o);if(void 0!==n.html){n.innerHTML=n.html,n.rootElement=n.firstElementChild,n.querySelectorAll("*").forEach(function(e){if(e.hasAttribute("golgi:prop")){let t=e.getAttribute("golgi:prop");n[t]=e,e.removeAttribute("golgi:prop")}}),n.childrenTarget||(n.childrenTarget=n.rootElement);let e="golgi:component-class",t=n.rootElement.getAttribute(e);if(t){t.split(" ").forEach(function(e){n.classList.add(e)}),n.rootElement.removeAttribute(e)}}if(n.getParentComponent=this.getParentComponent.bind(n),n.onUnload=this.onUnload.bind(n),n.registerUnloadMethod=this.registerUnloadMethod.bind(n),n.remove=this.remove.bind(n),n.getComponentByName=this.getComponentByName.bind(this),n.addHandler=this.addHandler.bind(n),n.addMetaTag=this.addMetaTag,n.loadResources=this.loadResources,n.loadJSAsync=this.loadJSAsync,n.loadJS=this.loadJS,n.loadCSSAsync=this.loadCSSAsync,n.loadCSS=this.loadCSS,n.loadGroup=this.loadGroup.bind(this),n.renderAssembly=this.renderAssembly.bind(this),n.renderComponent=this.renderComponent.bind(this),n.observerStart=this.observerStart,n.methodsToRemove=[],n.golgi_state=this.golgi_state,log&&(console.log("Golgi Component instantiated and ready for use:"),console.log(n)),n.onBeforeState&&("AsyncFunction"===n.onBeforeState.constructor.name?await n.onBeforeState():n.onBeforeState()),e.state&&n.setState){for(let t in e.state)"function"==typeof e.state[t]&&(e.state[t]=e.state[t].call(n));n.setState(e.state)}if(e.stateMap){e.state_map=new Map;for(let t in e.stateMap)e.state_map.set(t,e.stateMap[t])}if(e.state_map&&e.state_map.forEach(function(e,t){golgi.stateMap.has(t)||golgi.stateMap.set(t,[]),golgi.stateMap.get(t).push({component:n,method:e})}),n.onBeforeHooks&&n.onBeforeHooks(),e.hook)try{e.hook.call(n)}catch(t){log&&(console.log("Unable to execute hook "+name+" for "+e.componentName),console.log(t))}return n.onAfterHooks&&n.onAfterHooks(),n},renderAssembly:async function(e,t,o){let n;if(t||o||"object"!=typeof e?n=e:(t=e.targetElement,o=e.context,n=e.name),!t)return;if(!o)return;if(!n)return;if(""===n)return;let a=o.assemblyPath;""===a&&(a="./"),"/"!==a.slice(-1)&&(a+="/");let s=(await import(a+n+".js")).load.call(this,o),l=s.json||{};return s.gx&&(l=this.parse(s.gx,s.hooks)),l&&(Array.isArray(l)||(l=[l]),l.forEach(function(e,t){l[t].assemblyName=n})),await this.loadGroup(l,t,o)},async renderComponent(e,t,o){"body"===t&&(t=document.getElementsByTagName("body")[0]);let n=t.getElementsByTagName(e).length,a=[{componentName:e}];return await this.loadGroup(a,t,o),t.getElementsByTagName(e)[n]},getParentComponent(e){"string"==typeof(e=e||{})&&(e={match:e});let t=e.prefix||this.tagName.split("-")[0];return function o(n){if(!(n=n.parentNode))return null;if(e.match){if(n.tagName===e.match.toUpperCase())return n}else if(n.tagName.startsWith(t))return n;return o(n)}(this)},getComponentByName(e,t,o){let n,a=[...(o=o||document).getElementsByTagName(e.toUpperCase())];if(!t)return a;for(n=0;n<a.length;n++)if(a[n].name===t)return a[n]},addHandler:function(e,t,o){o||"string"!=typeof t||(o=t,t=null),o=o||"click",(t=t||this.rootElement).addEventListener(o,e),this.listeners||(this.listeners=[]),this.listeners.push({type:o,fn:e,target:t})},registerUnloadMethod(e){this.methodsToRemove.push(e)},onUnload:function(){log&&(console.log("removing Golgi COmponent:"),console.log(this)),this.listeners&&this.listeners.forEach(function(e){log&&(console.log("removing listener"),console.log(e)),e.target.removeEventListener(e.type,e.fn)}),this.methodsToRemove.forEach(function(e){log&&(console.log("invoking custom unload method"),console.log(e)),e()})},remove:function(){!function e(t){[...t.childNodes].forEach(function(t){1===t.nodeType&&(e(t),t.isComponent&&(t.onUnload(),t.parentNode.removeChild(t)))})}(this),this.onUnload(),this.parentNode.removeChild(this)},parse:function(e,t){let o='<xml xmlns="http://mgateway.com" xmlns:assembly="http://mgateway.com" xmlns:golgi="http://mgateway.com">'+e+"</xml>",n=[];return function e(o,n){[...o.childNodes].forEach(function(a){if(1===a.nodeType){if(["script","css","meta"].includes(a.tagName))return;let s={componentName:a.tagName};if(a.hasAttributes())if(a.tagName.includes("-")||a.tagName.includes(":")){s.state={};let e=[...a.attributes],n={};e.forEach(function(e){let l=e.value;if("true"===l)l=!0;else if("false"===l)l=!1;else try{l=JSON.parse(l)}catch(e){}if("golgi:hook"===e.name&&t&&t[a.tagName]&&t[a.tagName][l]&&(s.hook=t[a.tagName][l]),"golgi:stateMap"===e.name){let e=l.split(":")[0];s.state_map||(s.state_map=new Map),s.state_map.set(e,l.split(":")[1])}else if("golgi:appendTo"===e.name)s.targetElement={componentName:o.tagName,target:l};else if(e.name.includes(".")){let t=e.name.split("."),o=t.length,a=n;t.forEach(function(e,t){a[e]||(a[e]={}),t===o-1?a[e]=l:a=a[e]})}else s.state[e.name]=l});for(let e in n)s.state[e]=n[e]}else s.attributes={},[...a.attributes].forEach(function(e){"golgi:appendTo"===e.name&&(s.targetElement={componentName:o.tagName,target:e.value}),"golgi:hook"===e.name&&t&&t[a.tagName]&&t[a.tagName][e.value]?s.hook=t[a.tagName][e.value]:s.attributes[e.name]=e.value});a.tagName.includes("-")||0!==a.childElementCount||(s.textContent=a.textContent,s.childElementCount=a.childElementCount),a.hasChildNodes()&&(s.children=[],[...a.childNodes].forEach(function(e){if(1===e.nodeType&&["script","css","meta"].includes(e.tagName)){s[e.tagName]||(s[e.tagName]=[]);let t={};[...e.attributes].forEach(function(e){t[e.name]=e.value}),s[e.tagName].push(t)}}),e(a,s.children)),n.push(s)}})}((new DOMParser).parseFromString(o,"text/xml").documentElement,n),n},observerStart(){log&&(console.log("running observerStart on this:"),console.log(this)),this.observerCallback&&golgi.observer.observe(this,{attributes:!0,attributeOldValue:!0,characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0})},observer:new MutationObserver(function(e){e.forEach(function(e){let t=function(e){let t=!1,o=e;do{(o=o.parentElement)&&!o.tagName.includes("-")||(t=!0)}while(!t);return o}(e.target);t.observerCallback&&t.observerCallback(e)})})};golgi.golgi_state=new Proxy(golgi.dataStore,{get:function(e,t,o){return setTimeout(function(){var o,n;o=t,n=e[t],golgi.stateMap.has(o)&&golgi.stateMap.get(o).forEach(e=>{let t={};t[e.method]=n,e.component.setState(t)})},100),e[t]},set:function(e,t,o){let n=[];function a(e,t){log&&(console.log("trying to apply state for mapKey "+e+" = "+t),console.log(golgi.stateMap)),golgi.stateMap.has(e)&&golgi.stateMap.get(e).forEach(e=>{let o={};o[e.method]=t,e.component.setState(o)})}return golgi.dataStore[t]=o,"object"==typeof o&&function e(t,o){log&&(console.log("getProps called for "+t),console.log(o)),n.push(t),a(n.join("."),o),Object.entries(o).forEach((t,o)=>{const[s,l]=t;"object"!=typeof l?a(n.join(".")+"."+s,l):(e(s,l),n.pop())})}(t,o),"string"==typeof o&&a(t,o),!0}});export{golgi};