let count=0,golgi={dataStore:{},components:[],stateMap:new Map,resourceLoaded:new Map,logging:!1,setLog:function(e){this.logging=e},loadJSAsync:async function(e,t){return await golgi.loadJSFilePromise(e,t)},loadJSFilePromise:async function(e,t){let o=this;return new Promise(n=>{o.loadJS(e,t,function(e){n(e)})})},loadJS:function(e,t,o){let n;t&&(o||"function"!=typeof t?"object"==typeof t&&(n=t.crossorigin):o=t);let a=document.createElement("script");a.type="text/javascript",a.src=e;let s=this;a.onload=function(){s.logMessage("script "+e+" loaded"),o&&o(e)},n&&a.setAttribute("crossorigin",n),document.body.appendChild(a)},loadCSSAsync:async function(e,t){return await golgi.loadCSSPromise(e,t)},loadCSSPromise:async function(e,t){let o=this;return new Promise(n=>{o.loadCSS(e,t,function(e){n(e)})})},loadCSS:function(e,t,o){let n;t&&(o||"function"!=typeof t?"object"==typeof t&&(n=t.crossorigin,(t=t.target)||(t=document.getElementsByTagName("head")[0])):(o=t,t=document.getElementsByTagName("head")[0])),t||(t=document.getElementsByTagName("head")[0]);let a=t,s=document.createElement("link");s.rel="stylesheet",s.setAttribute("type","text/css"),s.href=e,n&&s.setAttribute("crossorigin",n);let i=this;s.onload=function(){i.logMessage("CSS file "+e+" loaded"),o&&o(e)},a.appendChild(s)},addMetaTag:function(e){let t,o=document.createElement("meta");for(t in e)o.setAttribute(t,e[t]);document.getElementsByTagName("head")[0].appendChild(o)},fetch_ssr:async function(e,t){let o=t.componentPaths[e]+"golgi-ssr.js";this.logMessage("fetching SSR file: "+o);try{const{golgi_components:t}=await import(o);t.forEach(function(e){e()})}catch(t){this.logMessage("Unable to fetch SSR module for "+e)}},prefetchAssemblies:function(e,t){e.forEach(function(e){golgi.prefetchAssembly(e,t)})},prefetchAssembly:async function(e,t){let o=t.assemblyPath;""===o&&(o="./"),"/"!==o.slice(-1)&&(o+="/");let n=(await import(o+e+".js")).load.call(this,t),a=n.gjson||{};n.gx&&(a=this.parse(n.gx,n.hooks)),a&&(Array.isArray(a)||(a=[a]),a.forEach(function(t,o){a[o].assemblyName=e})),this.preloadAssembly(a,t)},preloadComponent:async function(e,t){let o=e.componentName;if("assembly"!==o.split(":")[0]){if(o.includes("-"))this.preload(o,t);else if("script"===o){if(!golgi.resourceLoaded.has(e.src)){let t;e.crossorigin&&(t={crossorigin:e.crossorigin}),golgi.loadJS(e.src,t),golgi.resourceLoaded.set(e.src,!0)}}else if("css"===o&&!golgi.resourceLoaded.has(e.src)){let t;e.crossorigin&&(t={crossorigin:e.crossorigin}),golgi.loadCSS(e.src,t),golgi.resourceLoaded.set(e.src,!0)}e.children&&e.children[0]&&this.preloadAssembly(e.children,t)}else{let e=o.split("assembly:")[1];this.prefetchAssembly(e,t)}},preloadAssembly:function(e,t){for(const o of e)this.preloadComponent(o,t)},preloadComponents:function(e,t){e.forEach(function(e){golgi.preload(e,t)})},preload:async function(e,t){let o=e.split("-")[0];this.logMessage("*** preload "+e);let n=t.componentPath||"./";t.componentPaths&&t.componentPaths[o]&&(n=t.componentPaths[o]);let a=n;if("/"!==a.slice(-1)&&(a=n+"/"),!customElements.get(e)){let t=await import(n+e+".js"),o=customElements.get(e);o?this.logMessage("** preload: component "+e+" loaded by another loop"):(t.load.call(this),o=customElements.get(e),this.logMessage("** preload: component "+e+" had to be imported"))}},load:async function(e,t,o){let n=e.split("-")[0];this.logMessage("*** load "+e);let a=o.componentPath||"./";o.componentPaths&&o.componentPaths[n]&&(a=o.componentPaths[n]);let s=a;function i(e){let n=new e;return t?t.appendChild(n):golgi.components.push(n),n.context=o,n.path=a,n.rootPath=s,n.isComponent=!0,n}"/"!==s.slice(-1)&&(s=a+"/");let l=customElements.get(e);if(l){return this.logMessage("** component "+e+" already imported"),i(l)}{let t=await import(a+e+".js"),o=customElements.get(e);return o||(t.load.call(this),o=customElements.get(e),this.logMessage("** component "+e+" had to be imported")),i(o)}},loadGroup:async function(e,t,o){"body"===t&&(t=document.getElementsByTagName("body")[0]),o=o||{},Array.isArray(e)||(e=[e]);let n=e[0].assemblyName;for(const a of e)await this.processComponent(a,n,t,o)},processComponent:async function(e,t,o,n){let a=o;if(e.targetElement){let t=this.getParentComponent.call(a,e.targetElement.componentName);t&&t[e.targetElement.target]&&(a=t[e.targetElement.target])}if("assembly"===e.componentName.split(":")[0]){let t=e.componentName.split("assembly:")[1];if(await this.renderAssembly(t,a,n),e.hook)try{e.hook.call(this)}catch(e){this.logging&&(this.logMessage("Unable to execute hook "+name+" for "+config.componentName),console.log(e))}return}let s=await this.loadComponent(e,t,a,n);e.children&&e.children[0]&&s.childrenTarget&&(e.children.forEach(function(o,n){e.children[n].assemblyName=t}),await this.loadGroup(e.children,s.childrenTarget,n))},loadComponent:async function(e,t,o,n){let a=Object.assign({},e);if(!a.componentName.includes("-")&&!a.componentName.includes(":")){let e=document.createElement(a.componentName);e.textContent=a.textContent;for(let t in a.attributes)e.setAttribute(t,a.attributes[t]);if(e.childrenTarget=e,o&&o.appendChild(e),a.hook)try{"AsyncFunction"===a.hook.constructor.name?await a.hook.call(this):a.hook.call(this)}catch(e){this.logging&&(this.logMessage("Unable to execute hook "+name+" for "+a.componentName),console.log(e))}return e}a.meta&&a.meta.forEach(function(e){golgi.addMetaTag(e)});await Promise.all(["script","css"].map(async e=>{"script"===e&&a.script&&await Promise.all(a.script.map(async e=>{if(!golgi.resourceLoaded.has(e.src)){let t;e.crossorigin&&(t={crossorigin:e.crossorigin}),e.await?await golgi.loadJSAsync(e.src,t):golgi.loadJS(e.src,t),golgi.resourceLoaded.set(e.src,!0)}})),"css"===e&&a.css&&await Promise.all(a.css.map(async e=>{if(!golgi.resourceLoaded.has(e.src)){let t;e.crossorigin&&(t={crossorigin:e.crossorigin}),e.await?await golgi.loadCSSAsync(e.src,t):golgi.loadCSS(e.src,t),golgi.resourceLoaded.set(e.src,!0)}}))}));let s=await this.renderWebComponent(a,o,n);return s.parentComponent&&s.parentComponent.onChildComponentReady&&s.parentComponent.onChildComponentReady.call(s.parentComponent,s),s},renderWebComponent:async function(e,t,o){let n,a=await this.load(e.componentName,t,o);if(this.logging,a.shadowRoot?(a.rootElement=a.shadowRoot.firstElementChild,n=a.shadowRoot.querySelectorAll("*")):void 0!==a.html&&(a.innerHTML=a.html,a.rootElement=a.firstElementChild,n=a.querySelectorAll("*")),void 0!==a.rootElement){a.databinding=[],n.forEach(function(e){if(e.hasAttribute("golgi:prop")){let t=e.getAttribute("golgi:prop");a[t]=e,e.removeAttribute("golgi:prop"),e.ownerComponent=a}e.childNodes.forEach(function(t){if(3===t.nodeType&&t.nodeValue.startsWith("golgi:bind")){let o=t.nodeValue.split("golgi:bind=")[1]||"dummy",n=document.createElement("span");e.insertBefore(n,t);let s=function(e){let t=e;"object"==typeof e&&(t=e[o]),n.innerHTML=t};a.databinding.push(s),t.nodeValue=""}}),[...e.attributes].forEach(function(t){if(t.name.startsWith("golgi:on_")){let o=t.name.split("golgi:on_")[1],n=t.value;if(a[n]&&"function"==typeof a[n]){let t;t="AsyncFunction"===a[n].constructor.name?async function(e){await a[n](e)}:function(e){a[n](e)},golgi.addHandler.call(a,t,e,o)}e.removeAttribute(t.name)}if(t.value.startsWith("golgi:bind")){let o,n=t.value.split("golgi:bind=")[1];o="INPUT"===e.tagName||"TEXTAREA"===e.tagName&&"value"===t.name?function(t){let o=t;"object"==typeof t&&(o=t[n]),e.value=o}:function(o){let a=o;"object"==typeof o&&(a=o[n]),e.setAttribute(t.name,a)},a.databinding.push(o),e.removeAttribute(t.name)}})}),a.childrenTarget||(a.childrenTarget=a.rootElement),a.childrenTarget.ownerComponent=a;let e="golgi:component-class",t=a.rootElement.getAttribute(e);if(t){t.split(" ").forEach(function(e){a.classList.add(e)}),a.rootElement.removeAttribute(e)}}if(a.getParentComponent=this.getParentComponent.bind(a),a.onUnload=this.onUnload.bind(a),a.registerUnloadMethod=this.registerUnloadMethod.bind(a),a.remove=this.remove.bind(a),a.removeAllByName=this.removeAllByName,a.getComponentByName=this.getComponentByName.bind(this),a.addHandler=this.addHandler.bind(a),a.addMetaTag=this.addMetaTag,a.loadResources=this.loadResources,a.loadJSAsync=this.loadJSAsync,a.loadJS=this.loadJS.bind(this),a.loadCSSAsync=this.loadCSSAsync,a.loadCSS=this.loadCSS.bind(this),a.logging=this.logging,a.logMessage=this.logMessage.bind(this),a.loadGroup=this.loadGroup.bind(this),a.renderAssembly=this.renderAssembly.bind(this),a.renderComponent=this.renderComponent.bind(this),a.renderComponentMap=this.renderComponentMap.bind(this),a.observerStart=this.observerStart,a.methodsToRemove=[],a.golgi_state=this.golgi_state,a.addStateMap=this.addStateMap.bind(a),a.applyDataBinding=this.applyDataBinding.bind(a),a.registeredListenerTypes=new Map,a.on=this.on.bind(a),a.off=this.off.bind(a),a.emit=this.emit.bind(a),o.rootComponent||(o.rootComponent=a),a.rootComponent=o.rootComponent,t&&(a.parentComponent=t.ownerComponent),this.logging&&(this.logMessage("Golgi Component instantiated and ready for use:"),console.log(a)),a.onBeforeState&&("AsyncFunction"===a.onBeforeState.constructor.name?await a.onBeforeState():a.onBeforeState()),e.state){for(let t in e.state)a[t]&&"function"==typeof a[t]&&(a[t].call(a,e.state[t]),delete e.state[t]);e.state&&a.setState&&"function"==typeof a.setState&&a.setState(e.state)}if(e.stateMap){e.state_map=new Map;for(let t in e.stateMap)e.state_map.set(t,e.stateMap[t])}if(e.state_map&&e.state_map.forEach(function(e,t){golgi.stateMap.has(t)||golgi.stateMap.set(t,[]),golgi.stateMap.get(t).push({component:a,method:e})}),a.onBeforeHooks&&a.onBeforeHooks(),e.hook)try{"AsyncFunction"===e.hook.constructor.name?await e.hook.call(a):e.hook.call(a)}catch(t){this.logging&&(this.logMessage("Unable to execute hook "+name+" for "+e.componentName),console.log(t))}return a.onAfterHooks&&a.onAfterHooks(),a.emit("componentReady"),a},renderComponentMap:async function(e,t,o,n,a,s){let i=-1,l=a.split(":"),r=l[0],c=l[1];void 0!==c&&""!==c||(c="applyDataBinding");for(let a of n){let n=await this.renderComponent(e,t,o);s&&s.call(n,n,a);let l=r+"."+ ++i;n.addStateMap(l,c)}this.golgi_state[r]=n},renderAssembly:async function(e,t,o){let n;if(t||o||"object"!=typeof e?n=e:(t=e.targetElement,o=e.context,n=e.name),!o)return;if(!n)return;if(""===n)return;let a=o.assemblyPath;""===a&&(a="./"),"/"!==a.slice(-1)&&(a+="/");let s=(await import(a+n+".js")).load.call(this,o),i=s.gjson||{};return s.gx&&(i=this.parse(s.gx,s.hooks)),i&&(Array.isArray(i)||(i=[i]),i.forEach(function(e,t){i[t].assemblyName=n})),this.preloadAssembly(i,o),await this.loadGroup(i,t,o)},async renderComponent(e,t,o){"body"===t&&(t=document.getElementsByTagName("body")[0]);let n=0;t&&(n=t.getElementsByTagName(e).length);let a=[{componentName:e}];return await this.loadGroup(a,t,o),t?t.getElementsByTagName(e)[n]:golgi.components},getParentComponent(e){"string"==typeof(e=e||{})&&(e={match:e});let t=e.prefix||this.tagName.split("-")[0];return function o(n){if(!(n=n.parentNode))return null;if(e.match){if(n.tagName===e.match.toUpperCase())return n}else if(n.tagName.startsWith(t))return n;return o(n)}(this)},getComponentByName(e,t,o){let n,a=[...(o=o||document).getElementsByTagName(e.toUpperCase())];if(!t)return a;for(n=0;n<a.length;n++)if(a[n].name===t)return a[n]},addHandler:function(e,t,o){o||"string"!=typeof t||(o=t,t=null),o=o||"click",(t=t||this.rootElement).addEventListener(o,e),this.listeners||(this.listeners=[]),this.listeners.push({type:o,fn:e,target:t})},registerUnloadMethod(e){this.methodsToRemove.push(e)},onUnload:function(){this.logging&&(this.logMessage("removing Golgi COmponent:"),console.log(this));for(const e of this.registeredListenerTypes.keys())this.logMessage("removing customHandler for type "+e),this.off(e);let e=this;this.listeners&&this.listeners.forEach(function(t){e.logging&&(e.logMessage("removing listener"),console.log(t)),t.target.removeEventListener(t.type,t.fn)}),this.methodsToRemove.forEach(function(t){e.logging&&(e.logMessage("invoking custom unload method"),console.log(t)),t()})},remove:function(){!function e(t){[...t.childNodes].forEach(function(t){1===t.nodeType&&(e(t),t.isComponent&&(t.onUnload(),t.parentNode.removeChild(t)))})}(this),this.onUnload(),this.parentNode.removeChild(this)},removeAllByName:function(e,t){let o;(o=t?[...t.getElementsByTagName(e)]:[...document.getElementsByTagName(e)])&&o.forEach(e=>{e.remove()})},on:function(e,t){if(!this.registeredListenerTypes.has(e)){let o=function(e){t(e.detail)};this.addEventListener(e,o),this.registeredListenerTypes.set(e,o)}},emit:function(e,t){if(this.registeredListenerTypes.has(e)){let o=new CustomEvent(e,{detail:t});this.dispatchEvent(o)}},off:function(e){if(this.registeredListenerTypes.has(e)){let t=this.registeredListenerTypes.get(e);this.removeEventListener(e,t),this.registeredListenerTypes.delete(e)}},logMessage:function(e){this.logging&&console.log(Date.now()+": "+e)},parse:function(e,t){let o='<xml xmlns="http://mgateway.com" xmlns:assembly="http://mgateway.com" xmlns:golgi="http://mgateway.com">'+e+"</xml>",n=[];return function e(o,n){[...o.childNodes].forEach(function(a){if(1===a.nodeType){if(["script","css","meta"].includes(a.tagName))return;let s={componentName:a.tagName};if(a.hasAttributes())if(a.tagName.includes("-")||a.tagName.includes(":")){s.state={};let e=[...a.attributes],n={};e.forEach(function(e){let i=e.value;if("true"===i)i=!0;else if("false"===i)i=!1;else try{i=JSON.parse(i)}catch(e){}if("golgi:hook"===e.name&&t&&t[a.tagName]&&t[a.tagName][i]&&(s.hook=t[a.tagName][i]),"golgi:stateMap"===e.name){let e=i.split(":")[0];s.state_map||(s.state_map=new Map);let t=i.split(":")[1];void 0!==t&&""!==t||(t="applyDataBinding"),s.state_map.set(e,t)}else if("golgi:appendTo"===e.name)s.targetElement={componentName:o.tagName,target:i};else if(e.name.includes(".")){let t=e.name.split("."),o=t.length,a=n;t.forEach(function(e,t){a[e]||(a[e]={}),t===o-1?a[e]=i:a=a[e]})}else s.state[e.name]=i});for(let e in n)s.state[e]=n[e]}else s.attributes={},[...a.attributes].forEach(function(e){"golgi:appendTo"===e.name&&(s.targetElement={componentName:o.tagName,target:e.value}),"golgi:hook"===e.name&&t&&t[a.tagName]&&t[a.tagName][e.value]?s.hook=t[a.tagName][e.value]:s.attributes[e.name]=e.value});a.tagName.includes("-")||0!==a.childElementCount||(s.textContent=a.textContent,s.childElementCount=a.childElementCount),a.hasChildNodes()&&(s.children=[],[...a.childNodes].forEach(function(e){if(1===e.nodeType&&["script","css","meta"].includes(e.tagName)){s[e.tagName]||(s[e.tagName]=[]);let t={};[...e.attributes].forEach(function(e){t[e.name]=e.value}),s[e.tagName].push(t)}}),e(a,s.children)),n.push(s)}})}((new DOMParser).parseFromString(o,"text/xml").documentElement,n),n},observerStart(){this.logging&&(this.logMessage("running observerStart on this:"),console.log(this)),this.observerCallback&&golgi.observer.observe(this,{attributes:!0,attributeOldValue:!0,characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0})},observer:new MutationObserver(function(e){e.forEach(function(e){let t=function(e){let t=!1,o=e;do{(o=o.parentElement)&&!o.tagName.includes("-")||(t=!0)}while(!t);return o}(e.target);t.observerCallback&&t.observerCallback(e)})}),addStateMap(e,t){t=t||"applyDataBinding",golgi.stateMap.has(e)||golgi.stateMap.set(e,[]),golgi.stateMap.get(e).push({component:this,method:t})},applyDataBinding(e){this.databinding.forEach(function(t){t(e)}),this.onDataUpdated&&this.onDataUpdated(e)}};golgi.golgi_state=new Proxy(golgi.dataStore,{get:function(e,t,o){return setTimeout(function(){!function(e,t){if(golgi.logging&&(golgi.logMessage("trying to apply state for mapKey "+e+" = "+t),console.log(golgi.stateMap)),golgi.stateMap.has(e)){let o=golgi.stateMap.get(e);o.forEach((e,n)=>{if(e.component)if(e.component[e.method])e.component[e.method](t);else{let o={};o[e.method]=t,e.component.setState(o)}else o.splice(n,1)})}}(t,e[t])},100),e[t]},set:function(e,t,o){let n=[];function a(e,t){if(golgi.logging&&(golgi.logMessage("trying to apply state for mapKey "+e+" = "+t),console.log(golgi.stateMap)),golgi.stateMap.has(e)){let o=golgi.stateMap.get(e);o.forEach((e,n)=>{if(e.component)if(e.component[e.method])e.component[e.method](t);else{let o={};o[e.method]=t,e.component.setState(o)}else o.splice(n,1)})}}return golgi.dataStore[t]=o,"object"==typeof o&&function e(t,o){golgi.logging&&(golgi.logMessage("getProps called for "+t),console.log(o)),n.push(t),a(n.join("."),o),Object.entries(o).forEach((t,o)=>{const[s,i]=t;"object"!=typeof i?a(n.join(".")+"."+s,i):(e(s,i),n.pop())})}(t,o),"string"!=typeof o&&"number"!=typeof o||a(t,o),!0}});export{golgi};