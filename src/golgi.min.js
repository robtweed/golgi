let log=!1,count=0,golgi={dataStore:{},stateMap:new Map,resourceLoaded:new Map,setLog:function(e){log=e},loadJSAsync:async function(e,t){return await golgi.loadJSFilePromise(e,t)},loadJSFilePromise:async function(e,t){let o=this;return new Promise(n=>{o.loadJS(e,t,function(e){n(e)})})},loadJS:function(e,t,o){let n;t&&(o||"function"!=typeof t?"object"==typeof t&&(n=t.crossorigin):o=t);let a=document.createElement("script");a.type="text/javascript",a.src=e,a.onload=function(){log&&console.log("script "+e+" loaded"),o&&o(e)},n&&a.setAttribute("crossorigin",n),document.body.appendChild(a)},loadCSSAsync:async function(e,t){return await golgi.loadCSSPromise(e,t)},loadCSSPromise:async function(e,t){let o=this;return new Promise(n=>{o.loadCSS(e,t,function(e){n(e)})})},loadCSS:function(e,t,o){let n;t&&(o||"function"!=typeof t?"object"==typeof t&&(n=t.crossorigin,(t=t.target)||(t=document.getElementsByTagName("head")[0])):(o=t,t=document.getElementsByTagName("head")[0])),t||(t=document.getElementsByTagName("head")[0]);let a=t,l=document.createElement("link");l.rel="stylesheet",l.setAttribute("type","text/css"),l.href=e,n&&l.setAttribute("crossorigin",n),l.onload=function(){log&&console.log("CSS file "+e+" loaded"),o&&o(e)},a.appendChild(l)},addMetaTag:function(e){let t,o=document.createElement("meta");for(t in e)o.setAttribute(t,e[t]);document.getElementsByTagName("head")[0].appendChild(o)},load:async function(e,t,o){let n=e.split("-")[0];log&&console.log("*** load "+e);let a=this,l=o.componentPath||"./";o.componentPaths&&o.componentPaths[n]&&(l=o.componentPaths[n]);let r=l;function s(e){let n=new e;return t.appendChild(n),n.context=o,n.path=l,n.rootPath=r,n.isComponent=!0,n.setState&&n.setState({golgi:a}),n}"/"!==r.slice(-1)&&(r=l+"/");let i=customElements.get(e);if(i){return log&&console.log("** component "+e+" already imported"),s(i)}{let o=await import(l+e+".js"),n=customElements.get(e);if(n||(o.load.call(this),n=customElements.get(e),log&&console.log("** component "+e+" had to be imported")),t){return s(n)}return}},loadGroup:async function(e,t,o){"body"===(t=t||"body")&&(t=document.getElementsByTagName("body")[0]),o=o||{},Array.isArray(e)||(e=[e]);let n=e[0].assemblyName,a=this,l=e.length;await async function r(s){if(s===l)return;let i=Object.assign({},e[s]),c=t;if(i.targetElement){let e=a.getParentComponent.call(c,i.targetElement.componentName);e[i.targetElement.target]&&(c=e[i.targetElement.target])}if(i.componentName){if("function"==typeof i.if&&!i.if(o))return void await r(s+1);if(!i.componentName.includes("-")&&!i.componentName.includes(":")){if(["script","css","meta"].includes(i.componentName))await r(s+1);else{let e=document.createElement(i.componentName);e.textContent=i.textContent;for(let t in i.attributes)e.setAttribute(t,i.attributes[t]);e.childrenTarget=e,c.appendChild(e),i.children&&i.children[0]&&e.childrenTarget?(n&&i.children.forEach(function(e,t){i.children[t].assemblyName=n}),await a.loadGroup(i.children,e.childrenTarget,o),await r(s+1)):await r(s+1)}return}if("assembly"===i.componentName.split(":")[0]){let e=i.componentName.split("assembly:")[1];if(await a.renderAssembly(e,c,o),i.hook)try{i.hook.call(a)}catch(e){log&&(console.log("Unable to execute hook "+name+" for "+i.componentName),console.log(e))}return void await r(s+1)}let e=await a.load(i.componentName,c,o);if(log&&(console.log("load element: "+i.componentName),console.log(e),console.log(t)),void 0!==e.html){e.innerHTML=e.html,e.rootElement=e.firstElementChild,e.querySelectorAll("*").forEach(function(t){if(t.hasAttribute("golgi:prop")){let o=t.getAttribute("golgi:prop");e[o]=t,t.removeAttribute("golgi:prop")}}),e.childrenTarget||(e.childrenTarget=e.rootElement);let t="golgi:component-class",o=e.rootElement.getAttribute(t);o&&(o.split(" ").forEach(function(t){e.classList.add(t)}),e.rootElement.removeAttribute(t))}if(e.getParentComponent=a.getParentComponent.bind(e),e.onUnload=a.onUnload.bind(e),e.registerUnloadMethod=a.registerUnloadMethod.bind(e),e.remove=a.remove.bind(e),e.getComponentByName=a.getComponentByName.bind(a),e.addHandler=a.addHandler.bind(e),e.addMetaTag=a.addMetaTag,e.loadResources=a.loadResources,e.loadJSAsync=a.loadJSAsync,e.loadJS=a.loadJS,e.loadCSSAsync=a.loadCSSAsync,e.loadCSS=a.loadCSS,e.loadGroup=a.loadGroup.bind(a),e.renderAssembly=a.renderAssembly.bind(a),e.renderComponent=a.renderComponent.bind(a),e.observerStart=a.observerStart,e.methodsToRemove=[],e.golgi_state=a.state,i.children&&await Promise.all(i.children.map(async e=>{if("script"===e.componentName&&e.attributes&&e.attributes.src){let t=e.attributes.src;if(!golgi.resourceLoaded.has(t)){let o;e.attributes.crossorigin&&(o={crossorigin:e.attributes.crossorigin}),e.attributes.await?await golgi.loadJSAsync(t,o):golgi.loadJS(t,o),golgi.resourceLoaded.set(t,!0)}}if("css"===e.componentName&&e.attributes&&e.attributes.src){let t=e.attributes.src;if(!golgi.resourceLoaded.has(t)){let t;e.attributes.crossorigin&&(t={crossorigin:e.attributes.crossorigin}),e.attributes.await?await golgi.loadCSSAsync(e.attributes.src,t):golgi.loadCSS(e.attributes.src,t)}golgi.resourceLoaded.set(t,!0)}"meta"===e.componentName&&e.attributes&&golgi.addMetaTag(e.attributes)})),log&&(console.log("Golgi Component instantiated and ready for use:"),console.log(e)),e.onBeforeState&&("AsyncFunction"===e.onBeforeState.constructor.name?await e.onBeforeState():e.onBeforeState()),i.state&&e.setState){for(let t in i.state)"function"==typeof i.state[t]&&(i.state[t]=i.state[t].call(e));e.setState(i.state)}if(i.stateMap){i.state_map=new Map;for(let e in i.stateMap)i.state_map.set(e,i.stateMap[e])}if(i.state_map&&i.state_map.forEach(function(t,o){a.stateMap.has(o)||a.stateMap.set(o,[]),a.stateMap.get(o).push({component:e,method:t})}),e.onBeforeHooks&&e.onBeforeHooks(),i.hook)try{i.hook.call(e)}catch(e){log&&(console.log("Unable to execute hook "+name+" for "+i.componentName),console.log(e))}e.onAfterHooks&&e.onAfterHooks(),i.children&&i.children[0]&&e.childrenTarget?(n&&i.children.forEach(function(e,t){i.children[t].assemblyName=n}),await a.loadGroup(i.children,e.childrenTarget,o),await r(s+1)):await r(s+1)}}(0)},renderAssembly:async function(e,t,o){let n;if(t||o||"object"!=typeof e?n=e:(t=e.targetElement,o=e.context,n=e.name),!t)return;if(!o)return;if(!n)return;if(""===n)return;let a=o.assemblyPath;""===a&&(a="./"),"/"!==a.slice(-1)&&(a+="/");let l=(await import(a+n+".js")).load.call(this,o),r=l.json||{};return l.gx&&(r=this.parse(l.gx,l.hooks)),r&&(Array.isArray(r)||(r=[r]),r.forEach(function(e,t){r[t].assemblyName=n})),await this.loadGroup(r,t,o)},async renderComponent(e,t,o){"body"===t&&(t=document.getElementsByTagName("body")[0]);let n=t.getElementsByTagName(e).length,a=[{componentName:e}];return await this.loadGroup(a,t,o),t.getElementsByTagName(e)[n]},getParentComponent(e){"string"==typeof(e=e||{})&&(e={match:e});let t=e.prefix||this.tagName.split("-")[0];return function o(n){if(!(n=n.parentNode))return null;if(e.match){if(n.tagName===e.match.toUpperCase())return n}else if(n.tagName.startsWith(t))return n;return o(n)}(this)},getComponentByName(e,t,o){let n,a=[...(o=o||document).getElementsByTagName(e.toUpperCase())];if(!t)return a;for(n=0;n<a.length;n++)if(a[n].name===t)return a[n]},addHandler:function(e,t,o){o||"string"!=typeof t||(o=t,t=null),o=o||"click",(t=t||this.rootElement).addEventListener(o,e),this.listeners||(this.listeners=[]),this.listeners.push({type:o,fn:e,target:t})},registerUnloadMethod(e){this.methodsToRemove.push(e)},onUnload:function(){log&&(console.log("removing Golgi COmponent:"),console.log(this)),this.listeners&&this.listeners.forEach(function(e){log&&(console.log("removing listener"),console.log(e)),e.target.removeEventListener(e.type,e.fn)}),this.methodsToRemove.forEach(function(e){log&&(console.log("invoking custom unload method"),console.log(e)),e()})},remove:function(){!function e(t){[...t.childNodes].forEach(function(t){1===t.nodeType&&(e(t),t.isComponent&&(t.onUnload(),t.parentNode.removeChild(t)))})}(this),this.onUnload(),this.parentNode.removeChild(this)},parse:function(e,t){let o='<xml xmlns="http://mgateway.com" xmlns:assembly="http://mgateway.com" xmlns:golgi="http://mgateway.com">'+e+"</xml>",n=[];return function e(o,n){[...o.childNodes].forEach(function(a){if(1===a.nodeType){let l={componentName:a.tagName};if(a.hasAttributes())if(a.tagName.includes("-")||a.tagName.includes(":")){l.state={};let e=[...a.attributes],n={};e.forEach(function(e){let r=e.value;if("true"===r)r=!0;else if("false"===r)r=!1;else try{r=JSON.parse(r)}catch(e){}if("golgi:hook"===e.name&&t&&t[a.tagName]&&t[a.tagName][r]&&(l.hook=t[a.tagName][r]),"golgi:stateMap"===e.name){let e=r.split(":")[0];l.state_map||(l.state_map=new Map),l.state_map.set(e,r.split(":")[1])}else if("golgi:appendTo"===e.name)l.targetElement={componentName:o.tagName,target:r};else if(e.name.includes(".")){let t=e.name.split("."),o=t.length,a=n;t.forEach(function(e,t){a[e]||(a[e]={}),t===o-1?a[e]=r:a=a[e]})}else l.state[e.name]=r});for(let e in n)l.state[e]=n[e]}else l.attributes={},[...a.attributes].forEach(function(e){l.attributes[e.name]=e.value});a.tagName.includes("-")||0!==a.childElementCount||(l.textContent=a.textContent,l.childElementCount=a.childElementCount),a.hasChildNodes()&&(l.children=[],e(a,l.children)),n.push(l)}})}((new DOMParser).parseFromString(o,"text/xml").documentElement,n),n},observerStart(){console.log("running observerStart on this:"),console.log(this),this.observerCallback&&golgi.observer.observe(this,{attributes:!0,attributeOldValue:!0,characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0})},observer:new MutationObserver(function(e){e.forEach(function(e){let t=function(e){let t=!1,o=e;do{(o=o.parentElement)&&!o.tagName.includes("-")||(t=!0)}while(!t);return o}(e.target);t.observerCallback&&t.observerCallback(e)})}),state:new Proxy({},{set:function(e,t,o){let n=[];function a(e,t){golgi.stateMap.has(e)&&golgi.stateMap.get(e).forEach(e=>{let o={};o[e.method]=t,e.component.setState(o)})}return golgi.dataStore[t]=o,"object"==typeof o&&function e(t,o){console.log("getProps called for "+t),console.log(o),n.push(t),a(n.join("."),o),Object.entries(o).forEach((t,o)=>{const[l,r]=t;"object"!=typeof r?a(n.join(".")+"."+l,r):(e(l,r),n.pop())})}(t,o),"string"==typeof o&&a(t,o),!0}})};export{golgi};