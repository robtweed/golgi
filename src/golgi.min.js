let count=0,golgi={dataStore:{},components:[],componentsByName:{},assemblies:new Map,stateMap:new Map,resourceLoaded:new Map,listeners:new Map,logging:!1,version:"1.5.1",setLog:function(e){this.logging=e},loadJSAsync:async function(e,t){return golgi.loadJSFilePromise(e,t)},loadJSFilePromise:async function(e,o){let n=this;return new Promise(t=>{n.loadJS(e,o,function(e){t(e)})})},loadJS:function(e,t,o){let n;t&&(o||"function"!=typeof t?"object"==typeof t&&(n=t.crossorigin):o=t);t=document.createElement("script");t.type="text/javascript",t.src=e;let a=this;t.onload=function(){a.logMessage("script "+e+" loaded"),o&&o(e)},n&&t.setAttribute("crossorigin",n),document.body.appendChild(t)},loadCSSAsync:async function(e,t){return golgi.loadCSSPromise(e,t)},loadCSSPromise:async function(e,o){let n=this;return new Promise(t=>{n.loadCSS(e,o,function(e){t(e)})})},loadCSS:function(e,t,o){let n;t&&(o||"function"!=typeof t?"object"==typeof t&&(n=t.crossorigin,t=(t=t.target)||document.getElementsByTagName("head")[0]):(o=t,t=document.getElementsByTagName("head")[0]));var t=t=t||document.getElementsByTagName("head")[0],a=document.createElement("link");a.rel="stylesheet",a.setAttribute("type","text/css"),a.href=e,n&&a.setAttribute("crossorigin",n);let s=this;a.onload=function(){s.logMessage("CSS file "+e+" loaded"),o&&o(e)},t.appendChild(a)},addMetaTag:function(e){var t=document.createElement("meta");let o;for(o in e)t.setAttribute(o,e[o]);document.getElementsByTagName("head")[0].appendChild(t)},fetch_optimised_components:async function(e,t){t=t||"golgi-components.js";this.logMessage("fetching optimised file of all components: "+t);let o="";e.version&&""!==e.version&&(o="?version="+e.version);e=(await import(t+o)).golgi_components;let n=this;e.forEach(function(e){if(!customElements.get(e.n))try{e.f(),n.logMessage(e.n+" loaded")}catch(e){n.logMessage("Unable to fetch optimised component module"),console.log(e)}})},fetch_optimised_assemblies:async function(e,t){t=e.assemblyPath+(t||"golgi-assemblies.js");this.logMessage("fetching optimised file of all assemblies: "+t);let o=this,n="";e.version&&""!==e.version&&(n="?version="+e.version);try{var a=(await import(t+n)).golgi_assemblies;a.forEach(function(e){o.assemblies.set(e.n,e.c)})}catch(e){this.logMessage("Unable to fetch optimised assembly module")}this.emit("assembliesLoaded")},load:async function(o,t,n){var a=o.split("-")[0];this.logMessage("*** load "+o);let s=n.componentPath||"./",i=s=n.componentPaths&&n.componentPaths[a]?n.componentPaths[a]:s;function l(e){e=new e;return t?t.appendChild(e):golgi.components.push(e),e.context=n,e.path=s,e.rootPath=i,e.isComponent=!0,e}"/"!==i.slice(-1)&&(i=s+"/");a=customElements.get(o);if(a)return this.logMessage("** component "+o+" already imported"),l(a);{let e="";n.version&&""!==n.version&&(e="?version="+n.version);a=await import(s+o+".js"+e);n.golgiLoadSequence||(n.golgiLoadSequence=[]),n.golgiLoadSequence.push(o),this.logging&&(this.logMessage("Component Load Sequence so far:"),console.log(n.golgiLoadSequence));let t=customElements.get(o);return t||(a.load.call(this),t=customElements.get(o),this.logMessage("** component "+o+" had to be imported")),l(t)}},loadGroup:async function(e,t,o,n){"body"===t&&(t=document.getElementsByTagName("body")[0]),o=o||{};var a=(e=Array.isArray(e)?e:[e])[0].assemblyName;for(const s of e)await this.processComponent(s,a,t,o,n)},processComponent:async function(o,n,e,t,a){let s=e;if(o.targetElement&&(e=this.getParentComponent.call(s,o.targetElement.componentName))&&e[o.targetElement.target]&&(s=e[o.targetElement.target]),"assembly"===o.componentName.split(":")[0]){e=o.componentName.split("assembly:")[1];if(await this.renderAssembly(e,s,t),o.hook)try{o.hook.call(this,t)}catch(e){this.logging&&(this.logMessage("Unable to execute hook "+name+" for "+config.componentName),console.log(e))}}else{e=await this.loadComponent(o,n,s,t,a);o.children&&o.children[0]&&e.childrenTarget&&(o.children.forEach(function(e,t){o.children[t].assemblyName=n}),await this.loadGroup(o.children,e.childrenTarget,t,a))}},loadComponent:async function(e,t,o,n,a){let s=Object.assign({},e);if(!s.componentName.includes("-")&&!s.componentName.includes(":")){var i,l=document.createElement(s.componentName);for(i in l.textContent=s.textContent,s.attributes)"golgi:ref"===i?a[s.attributes[i]]=l:l.setAttribute(i,s.attributes[i]);if(l.childrenTarget=l,o&&o.appendChild(l),s.hook)try{var r={...this};r.element=l,"AsyncFunction"===s.hook.constructor.name?await s.hook.call(r,n):s.hook.call(r,n)}catch(e){this.logging&&(this.logMessage("Unable to execute hook "+name+" for "+s.componentName),console.log(e))}return l}s.meta&&s.meta.forEach(function(e){golgi.addMetaTag(e)});await Promise.all(["script","css"].map(async e=>{"script"===e&&s.script&&await Promise.all(s.script.map(async t=>{if(!golgi.resourceLoaded.has(t.src)){let e;t.crossorigin&&(e={crossorigin:t.crossorigin}),t.await?await golgi.loadJSAsync(t.src,e):golgi.loadJS(t.src,e),golgi.resourceLoaded.set(t.src,!0)}})),"css"===e&&s.css&&await Promise.all(s.css.map(async t=>{if(!golgi.resourceLoaded.has(t.src)){let e;t.crossorigin&&(e={crossorigin:t.crossorigin}),t.await?await golgi.loadCSSAsync(t.src,e):golgi.loadCSS(t.src,e),golgi.resourceLoaded.set(t.src,!0)}}))}));e=await this.renderWebComponent(s,o,n,a);return e.parentComponent&&e.parentComponent.onChildComponentReady&&e.parentComponent.onChildComponentReady.call(e.parentComponent,e),e},renderWebComponent:async function(t,e,o,n){let a=t.assemblyName,s=await this.load(t.componentName,e,o);var i;n&&t.state&&t.state["golgi:ref"]&&(n[t.state["golgi:ref"]]=s,delete t.state["golgi:ref"]),this.logging;let l;if(s.shadowRoot){if(s.rootElement=s.shadowRoot.firstElementChild,"STYLE"===s.rootElement.tagName){let e=!1,t=s.rootElement;for(;!(e=t.nextSibling&&1===(t=t.nextSibling).nodeType?!0:e););e?s.rootElement=t:s.rootElement=s.shadowRoot.firstElementChild}l=s.shadowRoot.querySelectorAll("*")}else void 0!==s.html&&(s.innerHTML=s.html,s.rootElement=s.firstElementChild,l=s.querySelectorAll("*"));if(void 0!==s.rootElement&&(s.databinding=[],l.forEach(function(a){var e;a.hasAttribute("golgi:prop")&&(e=a.getAttribute("golgi:prop"),(s[e]=a).removeAttribute("golgi:prop")),a.ownerComponent=s,a.childNodes.forEach(function(e){if(3===e.nodeType){var o=e.nodeValue.toString();if(e.nodeValue.includes("golgi:bind")){let o=e.nodeValue.split("golgi:bind=")[1]||"dummy",n=(o=o.split(";")[0],document.createElement("span"));a.insertBefore(n,e);s.databinding.push(function(e){let t=e;void 0!==(t="object"==typeof e?e[o]:t)&&(n.innerHTML=t)}),e.nodeValue=""}if(o.includes("golgi:observer")){let e=a,t=(a.firstChild&&"SPAN"===a.firstChild.tagName&&(e=a.firstChild),o.split("golgi:observer=")[1]);t=t.split(";")[0],golgi.observeText(e,s,t,a).observe(e,{childList:!0,subtree:!0})}}}),[...a.attributes].forEach(function(n){if(n.name.startsWith("golgi:on_")){var o=n.name.split("golgi:on_")[1];let t=n.value;if(s[t]&&"function"==typeof s[t]){let e;e="AsyncFunction"===s[t].constructor.name?async function(e){await s[t](e)}:function(e){s[t](e)},golgi.addHandler.call(s,e,a,o)}a.removeAttribute(n.name)}if(n.value.includes("golgi:bind")){let o=n.value.split("golgi:bind=")[1];o=o.split(";")[0];let e;e="INPUT"!==a.tagName&&"TEXTAREA"!==a.tagName||"value"!==n.name?function(e){let t=e;void 0!==(t="object"==typeof e?e[o]:t)&&a.setAttribute(n.name,t)}:function(e){let t=e;void 0!==(t="object"==typeof e?e[o]:t)&&(a.value=t)},s.databinding.push(e),a.removeAttribute(n.name)}if(n.value.includes("golgi:observer")){let e=n.value.split("golgi:observer=")[1];e=e.split(";")[0],golgi.observeAttr(n.name,e).observe(a,{attributeFilter:[n.name],attributeOldValue:!0})}})}),s.childrenTarget||(s.childrenTarget=s.rootElement),n="golgi:component-class",i=(s.childrenTarget.ownerComponent=s).rootElement.getAttribute(n))&&(i.split(" ").forEach(function(e){s.classList.add(e)}),s.rootElement.removeAttribute(n)),s.componentName=t.componentName,s.getParentComponent=this.getParentComponent.bind(s),s.onUnload=this.onUnload.bind(s),s.registerUnloadMethod=this.registerUnloadMethod.bind(s),s.remove=this.remove.bind(s),s.removeAllByName=this.removeAllByName,s.getComponentByName=this.getComponentByName.bind(this),s.getComponentsByName=this.getComponentsByName,s.addHandler=this.addHandler.bind(s),s.addMetaTag=this.addMetaTag,s.loadResources=this.loadResources,s.loadJSAsync=this.loadJSAsync,s.loadJS=this.loadJS.bind(this),s.loadCSSAsync=this.loadCSSAsync,s.loadCSS=this.loadCSS.bind(this),s.logging=this.logging,s.logMessage=this.logMessage.bind(this),s.loadGroup=this.loadGroup.bind(this),s.renderAssembly=this.renderAssembly.bind(this),s.renderComponent=this.renderComponent.bind(this),s.renderComponentMap=this.renderComponentMap.bind(this),s.observerStart=this.observerStart,s.methodsToRemove=[],s.golgi_state=this.golgi_state,s.addStateMap=this.addStateMap.bind(s),s.applyDataBinding=this.applyDataBinding.bind(s),s.registeredListenerTypes=new Map,s.on=this.el_on.bind(s),s.off=this.el_off.bind(s),s.emit=this.el_emit.bind(s),s.onAssemblyRendered=function(e,t){golgi.on(e+"_rendered",t,s)},s.ownerAssembly=a,s.onOwnerAssemblyRendered=function(e){golgi.on(a+"_rendered",e,s)},o.rootComponent||(o.rootComponent=s),s.rootComponent=o.rootComponent,e&&(s.parentComponent=e.ownerComponent),golgi.componentsByName[s.tagName]||(golgi.componentsByName[s.tagName]=[]),golgi.componentsByName[s.tagName].push(s),this.logging&&(this.logMessage("Golgi Component instantiated and ready for use:"),console.log(s)),s.onBeforeState&&("AsyncFunction"===s.onBeforeState.constructor.name?await s.onBeforeState():s.onBeforeState()),t.state){for(var r in t.state)s[r]&&"function"==typeof s[r]&&(s[r].call(s,t.state[r]),delete t.state[r]);t.state&&s.setState&&"function"==typeof s.setState&&s.setState(t.state)}if(t.stateMap)for(var g in t.state_map=new Map,t.stateMap)t.state_map.set(g,t.stateMap[g]);if(t.state_map&&t.state_map.forEach(function(e,t){golgi.stateMap.has(t)||golgi.stateMap.set(t,[]),golgi.stateMap.get(t).push({component:s,method:e})}),s.onBeforeHooks&&s.onBeforeHooks(),t.hook)try{"AsyncFunction"===t.hook.constructor.name?await t.hook.call(s,o):t.hook.call(s,o)}catch(e){this.logging&&(this.logMessage("Unable to execute hook "+name+" for "+t.componentName),console.log(e))}return s.onAfterHooks&&s.onAfterHooks(),s.emit("componentReady"),s},renderComponentMap:async function(e,t,o,n,a,s){let i=-1;var l,a=a.split(":"),r=a[0];let g=a[1];void 0!==g&&""!==g||(g="applyDataBinding");for(l of n){var c=await this.renderComponent(e,t,o),m=(s&&s.call(c,c,l),r+"."+ ++i);c.addStateMap(m,g)}this.golgi_state[r]=n},renderAssembly:async function(e,a,s){let i;var l={};if(i=a||s||"object"!=typeof e?e:(a=e.targetElement,s=e.context,e.name),s&&i&&""!==i){let t=s.assemblyPath;"/"!==(t=""===t?"./":t).slice(-1)&&(t+="/");let o;if(this.assemblies.has(i))o={load:this.assemblies.get(i)};else{let e="";s.version&&""!==s.version&&(e="?version="+s.version),o=await import(t+i+".js"+e)}e=o.load.call(this,s);let n=e.gjson||{};if(n=e.gx?this.parse(e.gx,e.hooks,s):n){Array.isArray(n)||(n=[n]);let o=!1;n.forEach(function(e,t){n[t].assemblyName=i,e.state&&"root"===e.state["golgi:ref"]&&(o=!0)}),o||(n[0].state||(n[0].state={}),n[0].state["golgi:ref"]="root")}await this.loadGroup(n,a,s,l),this.emit(i+"_rendered");var r,g=l.root;for(r in l)"root"!==r&&(g[r]=l[r]);return g.refs=l,g}},async renderComponent(e,t,o){let n=0;return(t="body"===t?document.getElementsByTagName("body")[0]:t)&&(n=t.getElementsByTagName(e).length),await this.loadGroup([{componentName:e}],t,o),t?t.getElementsByTagName(e)[n]:golgi.components},getParentComponent(o){"string"==typeof(o=o||{})&&(o={match:o}),this.element&&(this.tagName=this.element.tagName,this.parentNode=this.element.parentNode);let n=o.prefix||this.tagName.split("-")[0];return function e(t){if(!(t=11===t.nodeType?t.host:t.parentNode))return null;if(o.match){if(t.tagName===o.match.toUpperCase())return t}else if(t.tagName.startsWith(n))return t;return e(t)}(this)},getComponentsByName(e){return golgi.componentsByName[e.toUpperCase()]||[]},getComponentByName(e,t,o){var n=[...(o=o||document).getElementsByTagName(e.toUpperCase())];if(!t)return n;let a;for(a=0;a<n.length;a++)if(n[a].name===t)return n[a]},addHandler:function(e,t,o){o||"string"!=typeof t||(o=t,t=null),(t=t||this.rootElement).addEventListener(o=o||"click",e),this.listeners||(this.listeners=[]),this.listeners.push({type:o,fn:e,target:t})},registerUnloadMethod(e){this.methodsToRemove.push(e)},onUnload:function(){this.logging&&(this.logMessage("removing Golgi COmponent:"),console.log(this));for(const e of this.registeredListenerTypes.keys())this.logMessage("removing customHandler for type "+e),this.off(e);let t=this;this.listeners&&this.listeners.forEach(function(e){t.logging&&(t.logMessage("removing listener"),console.log(e)),e.target.removeEventListener(e.type,e.fn)}),this.methodsToRemove.forEach(function(e){t.logging&&(t.logMessage("invoking custom unload method"),console.log(e)),e()})},remove:function(){for(var e in!function t(e){[...e.childNodes].forEach(function(e){1===e.nodeType&&(t(e=e.shadowRoot||e),e.isComponent)&&(e.onUnload(),e.parentNode.removeChild(e))})}(this),this.onUnload(),golgi.componentsByName[this.tagName])if(golgi.componentsByName[this.tagName][e].name===this.name){golgi.componentsByName[this.tagName].splice(e,1);break}this.parentNode.removeChild(this)},removeAllByName:function(e,t){let o;(o=t?[...t.getElementsByTagName(e)]:[...document.getElementsByTagName(e)])&&o.forEach(e=>{e.remove()})},el_on:function(e,t){var o;this.registeredListenerTypes.has(e)||(this.addEventListener(e,o=function(e){t(e.detail)}),this.registeredListenerTypes.set(e,o))},el_emit:function(e,t){this.registeredListenerTypes.has(e)&&(e=new CustomEvent(e,{detail:t}),this.dispatchEvent(e))},el_off:function(e){var t;this.registeredListenerTypes.has(e)&&(t=this.registeredListenerTypes.get(e),this.removeEventListener(e,t),this.registeredListenerTypes.delete(e))},on:function(e,t,o){this.listeners.has(e)||this.listeners.set(e,{handler:t,context:o})},off:function(e){this.listeners.has(e)&&this.listeners.delete(e)},emit:function(e,t){var o;this.listeners.has(e)&&(o=(e=this.listeners.get(e)).context||this,e.handler.call(o,t))},logMessage:function(e){this.logging&&console.log(Date.now()+": "+e)},parse:function(e,g,c){var e='<xml xmlns="http://mgateway.com" xmlns:assembly="http://mgateway.com" xmlns:golgi="http://mgateway.com">'+e+"</xml>",t=[];return function s(l,r){[...l.childNodes].forEach(function(n){if(1===n.nodeType&&!["script","css","meta"].includes(n.tagName)){let o={componentName:n.tagName,state:{}};if(n.tagName.includes("-")&&""!==n.textContent.trim()){var t=[...n.childNodes];for(let e=0;e<t.length;e++){var a=t[e];if(3===a.nodeType&&""!==(a=a.textContent.trim())){o.state.textContent=a;break}}}if(n.hasAttributes())if(n.tagName.includes("-")||n.tagName.includes(":")){var e,i=[...n.attributes];let s={};for(e in i.forEach(function(e){let a=e.value;if("true"===a)a=!0;else if("false"===a)a=!1;else if(a.startsWith&&a.startsWith("golgi:context=")){var t=a.split("golgi:context=")[1].split(".");let o=c,n=!1;t.forEach(function(e,t){n||(void 0!==o[e]?o=o[e]:n=!0)}),a=n?"*Invalid context reference*":o}else try{a=JSON.parse(a)}catch(e){}if("golgi:hook"===e.name&&g&&g[n.tagName]&&g[n.tagName][a]&&(o.hook=g[n.tagName][a]),"golgi:stateMap"===e.name){t=a.split(":")[0],o.state_map||(o.state_map=new Map);let e=a.split(":")[1];void 0!==e&&""!==e||(e="applyDataBinding"),o.state_map.set(t,e)}else if("golgi:appendTo"===e.name)o.targetElement={componentName:l.tagName,target:a};else if(e.name.includes(".")){let o=(t=e.name.split(".")).length,n=s;t.forEach(function(e,t){n[e]||(n[e]={}),t===o-1?n[e]=a:n=n[e]})}else o.state[e.name]=a}),s)o.state[e]=s[e]}else o.attributes={},[...n.attributes].forEach(function(e){"golgi:appendTo"===e.name?o.targetElement={componentName:l.tagName,target:e.value}:"golgi:hook"===e.name&&g&&g[n.tagName]&&g[n.tagName][e.value]?o.hook=g[n.tagName][e.value]:o.attributes[e.name]=e.value});n.tagName.includes("-")||0!==n.childElementCount||(o.textContent=n.textContent,o.childElementCount=n.childElementCount),n.hasChildNodes()&&(o.children=[],[...n.childNodes].forEach(function(e){if(1===e.nodeType&&["script","css","meta"].includes(e.tagName)){o[e.tagName]||(o[e.tagName]=[]);let t={};[...e.attributes].forEach(function(e){t[e.name]=e.value}),o[e.tagName].push(t)}}),s(n,o.children)),r.push(o)}})}((new DOMParser).parseFromString(e,"text/xml").documentElement,t),t},observerStart(){var e;this.logging&&(this.logMessage("running observerStart on this:"),console.log(this)),this.observerCallback&&(e=this.shadowRoot||this,golgi.observer.observe(e,{attributes:!0,attributeOldValue:!0,characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0}))},observer:new MutationObserver(function(e){e.forEach(function(e){var t=function(e){let t=!1,o=e;for(;!(t=(o=11===(o=o.parentNode).nodeType?o.host:o)&&!o.tagName.includes("-")?t:!0););return o}(e.target);t.observerCallback&&t.observerCallback(e)})}),observeAttr(n,a){return new MutationObserver(function(e){e.forEach(function(e){var t,o;"attributes"===e.type&&(t=e.target.getAttribute(n),o=e.target.ownerComponent[a])&&e.target.ownerComponent&&t&&t!==e.oldValue&&o.call(e.target.ownerComponent,t,e.oldValue)})})},observeText(o,n,a,s){return new MutationObserver(function(e){e.forEach(function(e){var t;"childList"===e.type&&(e=o.textContent,t=n[a])&&e&&t.call(n,e,o,s)})})},addStateMap(e,t){t=t||"applyDataBinding",golgi.stateMap.has(e)||golgi.stateMap.set(e,[]),golgi.stateMap.get(e).push({component:this,method:t})},applyDataBinding(t){this.databinding.forEach(function(e){e(t)}),this.onDataUpdated&&this.onDataUpdated(t)}};golgi.golgi_state=new Proxy(golgi.dataStore,{get:function(t,o,e){return setTimeout(function(){var e=o,a=t[o];if(golgi.logging&&(golgi.logMessage("1 trying to apply state for mapKey "+e+":"),console.log(a)),golgi.stateMap.has(e)){let n=golgi.stateMap.get(e);n.forEach((e,t)=>{var o;e.component?e.component[e.method]?e.component[e.method](a):((o={})[e.method]=a,e.component.setState(o)):n.splice(t,1)})}},100),t[o]},set:function(e,t,o){let a=[];function s(e,a){if(golgi.logging&&(golgi.logMessage("2 trying to apply state for mapKey "+e+":"),console.log(a)),golgi.stateMap.has(e)){let n=golgi.stateMap.get(e);n.forEach((e,t)=>{var o;e.component?e.component[e.method]?e.component[e.method](a):((o={})[e.method]=a,e.component.setState(o)):n.splice(t,1)})}}return"object"==typeof(golgi.dataStore[t]=o)&&function n(e,t){golgi.logging&&(golgi.logMessage("getProps called for "+e),console.log(t)),a.push(e),s(a.join("."),t),Object.entries(t).forEach((e,t)=>{var[e,o]=e;"object"!=typeof o?s(a.join(".")+"."+e,o):(n(e,o),a.pop())})}(t,o),"string"!=typeof o&&"number"!=typeof o||s(t,o),!0}});export{golgi};
