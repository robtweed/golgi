let log=!1,count=0,golgi={dataStore:{},stateMap:new Map,resourceLoaded:new Map,setLog:function(e){log=e},loadJSAsync:async function(e,t){return await golgi.loadJSFilePromise(e,t)},loadJSFilePromise:async function(e,t){let o=this;return new Promise(n=>{o.loadJS(e,t,function(e){n(e)})})},loadJS:function(e,t,o){let n;t&&(o||"function"!=typeof t?"object"==typeof t&&(n=t.crossorigin):o=t);let a=document.createElement("script");a.type="text/javascript",a.src=e,a.onload=function(){log&&console.log("script "+e+" loaded"),o&&o(e)},n&&a.setAttribute("crossorigin",n),document.body.appendChild(a)},loadCSSAsync:async function(e,t){return await golgi.loadCSSPromise(e,t)},loadCSSPromise:async function(e,t){let o=this;return new Promise(n=>{o.loadCSS(e,t,function(e){n(e)})})},loadCSS:function(e,t,o){let n;t&&(o||"function"!=typeof t?"object"==typeof t&&(n=t.crossorigin,(t=t.target)||(t=document.getElementsByTagName("head")[0])):(o=t,t=document.getElementsByTagName("head")[0])),t||(t=document.getElementsByTagName("head")[0]);let a=t,l=document.createElement("link");l.rel="stylesheet",l.setAttribute("type","text/css"),l.href=e,n&&l.setAttribute("crossorigin",n),l.onload=function(){log&&console.log("CSS file "+e+" loaded"),o&&o(e)},a.appendChild(l)},addMetaTag:function(e){let t,o=document.createElement("meta");for(t in e)o.setAttribute(t,e[t]);document.getElementsByTagName("head")[0].appendChild(o)},load:async function(e,t,o){let n=e.split("-")[0];log&&console.log("*** load "+e);let a=this,l=o.componentPath||"./";o.componentPaths&&o.componentPaths[n]&&(l=o.componentPaths[n]);let s=l;function r(e){let n=new e;return t.appendChild(n),n.context=o,n.path=l,n.rootPath=s,n.isComponent=!0,n.setState&&n.setState({golgi:a}),n}"/"!==s.slice(-1)&&(s=l+"/");let i=customElements.get(e);if(i){return log&&console.log("** component "+e+" already imported"),r(i)}{let o=await import(l+e+".js"),n=customElements.get(e);if(n||(o.load.call(this),n=customElements.get(e),log&&console.log("** component "+e+" had to be imported")),t){return r(n)}return}},loadGroup:async function(e,t,o){"body"===(t=t||"body")&&(t=document.getElementsByTagName("body")[0]),o=o||{},Array.isArray(e)||(e=[e]);let n=e[0].assemblyName,a=this,l=e.length;await async function s(r){if(r===l)return;let i=Object.assign({},e[r]),c=t;if(i.targetElement){let e=a.getParentComponent.call(c,i.targetElement.componentName);e[i.targetElement.target]&&(c=e[i.targetElement.target])}if(i.componentName){if("function"==typeof i.if&&!i.if(o))return void await s(r+1);if(!i.componentName.includes("-")&&!i.componentName.includes(":")){if(["script","css","meta"].includes(i.componentName))await s(r+1);else{let e=document.createElement(i.componentName);e.textContent=i.textContent;for(let t in i.attributes)e.setAttribute(t,i.attributes[t]);e.childrenTarget=e,c.appendChild(e),i.children&&i.children[0]&&e.childrenTarget?(n&&i.children.forEach(function(e,t){i.children[t].assemblyName=n}),await a.loadGroup(i.children,e.childrenTarget,o),await s(r+1)):await s(r+1)}return}if("assembly"===i.componentName.split(":")[0]){let e=i.componentName.split("assembly:")[1];if(await a.renderAssembly(e,c,o),i.hook)try{i.hook.call(a)}catch(e){log&&(console.log("Unable to execute hook "+name+" for "+i.componentName),console.log(e))}return void await s(r+1)}i.meta&&i.meta.forEach(function(e){golgi.addMetaTag(e)});let e=["script","css"];await Promise.all(e.map(async e=>{"script"===e&&i.script&&await Promise.all(i.script.map(async e=>{if(!golgi.resourceLoaded.has(e.src)){let t;e.crossorigin&&(t={crossorigin:e.crossorigin}),e.await?await golgi.loadJSAsync(e.src,t):golgi.loadJS(e.src,t),golgi.resourceLoaded.set(e.src,!0)}})),"css"===e&&i.css&&await Promise.all(i.css.map(async e=>{if(!golgi.resourceLoaded.has(e.src)){let t;e.crossorigin&&(t={crossorigin:e.crossorigin}),e.await?await golgi.loadCSSAsync(e.src,t):golgi.loadCSS(e.src,t),golgi.resourceLoaded.set(e.src,!0)}}))}));let t=await a.load(i.componentName,c,o);if(log&&console.log("load element: "+i.componentName),void 0!==t.html){t.innerHTML=t.html,t.rootElement=t.firstElementChild,t.querySelectorAll("*").forEach(function(e){if(e.hasAttribute("golgi:prop")){let o=e.getAttribute("golgi:prop");t[o]=e,e.removeAttribute("golgi:prop")}}),t.childrenTarget||(t.childrenTarget=t.rootElement);let e="golgi:component-class",o=t.rootElement.getAttribute(e);o&&(o.split(" ").forEach(function(e){t.classList.add(e)}),t.rootElement.removeAttribute(e))}if(t.getParentComponent=a.getParentComponent.bind(t),t.onUnload=a.onUnload.bind(t),t.registerUnloadMethod=a.registerUnloadMethod.bind(t),t.remove=a.remove.bind(t),t.getComponentByName=a.getComponentByName.bind(a),t.addHandler=a.addHandler.bind(t),t.addMetaTag=a.addMetaTag,t.loadResources=a.loadResources,t.loadJSAsync=a.loadJSAsync,t.loadJS=a.loadJS,t.loadCSSAsync=a.loadCSSAsync,t.loadCSS=a.loadCSS,t.loadGroup=a.loadGroup.bind(a),t.renderAssembly=a.renderAssembly.bind(a),t.renderComponent=a.renderComponent.bind(a),t.observerStart=a.observerStart,t.methodsToRemove=[],t.golgi_state=a.state,log&&(console.log("Golgi Component instantiated and ready for use:"),console.log(t)),t.onBeforeState&&("AsyncFunction"===t.onBeforeState.constructor.name?await t.onBeforeState():t.onBeforeState()),i.state&&t.setState){for(let e in i.state)"function"==typeof i.state[e]&&(i.state[e]=i.state[e].call(t));t.setState(i.state)}if(i.stateMap){i.state_map=new Map;for(let e in i.stateMap)i.state_map.set(e,i.stateMap[e])}if(i.state_map&&i.state_map.forEach(function(e,o){a.stateMap.has(o)||a.stateMap.set(o,[]),a.stateMap.get(o).push({component:t,method:e})}),t.onBeforeHooks&&t.onBeforeHooks(),i.hook)try{i.hook.call(t)}catch(e){log&&(console.log("Unable to execute hook "+name+" for "+i.componentName),console.log(e))}t.onAfterHooks&&t.onAfterHooks(),i.children&&i.children[0]&&t.childrenTarget?(n&&i.children.forEach(function(e,t){i.children[t].assemblyName=n}),await a.loadGroup(i.children,t.childrenTarget,o),await s(r+1)):await s(r+1)}}(0)},renderAssembly:async function(e,t,o){let n;if(t||o||"object"!=typeof e?n=e:(t=e.targetElement,o=e.context,n=e.name),!t)return;if(!o)return;if(!n)return;if(""===n)return;let a=o.assemblyPath;""===a&&(a="./"),"/"!==a.slice(-1)&&(a+="/");let l=(await import(a+n+".js")).load.call(this,o),s=l.json||{};return l.gx&&(s=this.parse(l.gx,l.hooks)),s&&(Array.isArray(s)||(s=[s]),s.forEach(function(e,t){s[t].assemblyName=n})),await this.loadGroup(s,t,o)},async renderComponent(e,t,o){"body"===t&&(t=document.getElementsByTagName("body")[0]);let n=t.getElementsByTagName(e).length,a=[{componentName:e}];return await this.loadGroup(a,t,o),t.getElementsByTagName(e)[n]},getParentComponent(e){"string"==typeof(e=e||{})&&(e={match:e});let t=e.prefix||this.tagName.split("-")[0];return function o(n){if(!(n=n.parentNode))return null;if(e.match){if(n.tagName===e.match.toUpperCase())return n}else if(n.tagName.startsWith(t))return n;return o(n)}(this)},getComponentByName(e,t,o){let n,a=[...(o=o||document).getElementsByTagName(e.toUpperCase())];if(!t)return a;for(n=0;n<a.length;n++)if(a[n].name===t)return a[n]},addHandler:function(e,t,o){o||"string"!=typeof t||(o=t,t=null),o=o||"click",(t=t||this.rootElement).addEventListener(o,e),this.listeners||(this.listeners=[]),this.listeners.push({type:o,fn:e,target:t})},registerUnloadMethod(e){this.methodsToRemove.push(e)},onUnload:function(){log&&(console.log("removing Golgi COmponent:"),console.log(this)),this.listeners&&this.listeners.forEach(function(e){log&&(console.log("removing listener"),console.log(e)),e.target.removeEventListener(e.type,e.fn)}),this.methodsToRemove.forEach(function(e){log&&(console.log("invoking custom unload method"),console.log(e)),e()})},remove:function(){!function e(t){[...t.childNodes].forEach(function(t){1===t.nodeType&&(e(t),t.isComponent&&(t.onUnload(),t.parentNode.removeChild(t)))})}(this),this.onUnload(),this.parentNode.removeChild(this)},parse:function(e,t){let o='<xml xmlns="http://mgateway.com" xmlns:assembly="http://mgateway.com" xmlns:golgi="http://mgateway.com">'+e+"</xml>",n=[];return function e(o,n){[...o.childNodes].forEach(function(a){if(1===a.nodeType){if(["script","css","meta"].includes(a.tagName))return;let l={componentName:a.tagName};if(a.hasAttributes())if(a.tagName.includes("-")||a.tagName.includes(":")){l.state={};let e=[...a.attributes],n={};e.forEach(function(e){let s=e.value;if("true"===s)s=!0;else if("false"===s)s=!1;else try{s=JSON.parse(s)}catch(e){}if("golgi:hook"===e.name&&t&&t[a.tagName]&&t[a.tagName][s]&&(l.hook=t[a.tagName][s]),"golgi:stateMap"===e.name){let e=s.split(":")[0];l.state_map||(l.state_map=new Map),l.state_map.set(e,s.split(":")[1])}else if("golgi:appendTo"===e.name)l.targetElement={componentName:o.tagName,target:s};else if(e.name.includes(".")){let t=e.name.split("."),o=t.length,a=n;t.forEach(function(e,t){a[e]||(a[e]={}),t===o-1?a[e]=s:a=a[e]})}else l.state[e.name]=s});for(let e in n)l.state[e]=n[e]}else l.attributes={},[...a.attributes].forEach(function(e){l.attributes[e.name]=e.value});a.tagName.includes("-")||0!==a.childElementCount||(l.textContent=a.textContent,l.childElementCount=a.childElementCount),a.hasChildNodes()&&(l.children=[],[...a.childNodes].forEach(function(e){if(1===e.nodeType&&["script","css","meta"].includes(e.tagName)){l[e.tagName]||(l[e.tagName]=[]);let t={};[...e.attributes].forEach(function(e){t[e.name]=e.value}),l[e.tagName].push(t)}}),e(a,l.children)),n.push(l)}})}((new DOMParser).parseFromString(o,"text/xml").documentElement,n),n},observerStart(){log&&(console.log("running observerStart on this:"),console.log(this)),this.observerCallback&&golgi.observer.observe(this,{attributes:!0,attributeOldValue:!0,characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0})},observer:new MutationObserver(function(e){e.forEach(function(e){let t=function(e){let t=!1,o=e;do{(o=o.parentElement)&&!o.tagName.includes("-")||(t=!0)}while(!t);return o}(e.target);t.observerCallback&&t.observerCallback(e)})})};golgi.state=new Proxy(golgi.dataStore,{get:function(e,t,o){return setTimeout(function(){var o,n;o=t,n=e[t],golgi.stateMap.has(o)&&golgi.stateMap.get(o).forEach(e=>{let t={};t[e.method]=n,e.component.setState(t)})},100),e[t]},set:function(e,t,o){let n=[];function a(e,t){log&&(console.log("trying to apply state for mapKey "+e+" = "+t),console.log(golgi.stateMap)),golgi.stateMap.has(e)&&golgi.stateMap.get(e).forEach(e=>{let o={};o[e.method]=t,e.component.setState(o)})}return golgi.dataStore[t]=o,"object"==typeof o&&function e(t,o){log&&(console.log("getProps called for "+t),console.log(o)),n.push(t),a(n.join("."),o),Object.entries(o).forEach((t,o)=>{const[l,s]=t;"object"!=typeof s?a(n.join(".")+"."+l,s):(e(l,s),n.pop())})}(t,o),"string"==typeof o&&a(t,o),!0}});export{golgi};