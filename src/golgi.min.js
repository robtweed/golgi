let log=!1,count=0,golgi={dataStore:{},stateMap:new Map,resourceLoaded:new Map,setLog:function(t){log=t},loadJSAsync:async function(t,e){return await golgi.loadJSFilePromise(t,e)},loadJSFilePromise:async function(t,e){let o=this;return new Promise(n=>{o.loadJS(t,e,function(t){n(t)})})},loadJS:function(t,e,o){let n;e&&(o||"function"!=typeof e?"object"==typeof e&&(n=e.crossorigin):o=e);let a=document.createElement("script");a.type="text/javascript",a.src=t,a.onload=function(){log&&console.log("script "+t+" loaded"),o&&o(t)},n&&a.setAttribute("crossorigin",n),document.body.appendChild(a)},loadCSSAsync:async function(t,e){return await golgi.loadCSSPromise(t,e)},loadCSSPromise:async function(t,e){let o=this;return new Promise(n=>{o.loadCSS(t,e,function(t){n(t)})})},loadCSS:function(t,e,o){let n;e&&(o||"function"!=typeof e?"object"==typeof e&&(n=e.crossorigin,(e=e.target)||(e=document.getElementsByTagName("head")[0])):(o=e,e=document.getElementsByTagName("head")[0])),e||(e=document.getElementsByTagName("head")[0]);let a=e,i=document.createElement("link");i.rel="stylesheet",i.setAttribute("type","text/css"),i.href=t,n&&i.setAttribute("crossorigin",n),i.onload=function(){log&&console.log("CSS file "+t+" loaded"),o&&o(t)},a.appendChild(i)},addMetaTag:function(t){let e,o=document.createElement("meta");for(e in t)o.setAttribute(e,t[e]);document.getElementsByTagName("head")[0].appendChild(o)},load:async function(t,e,o){let n=t.split("-")[0];log&&console.log("*** load "+t);let a=this,i=o.componentPath||"./";o.componentPaths&&o.componentPaths[n]&&(i=o.componentPaths[n]);let l=i;function s(t){let n=new t;return e.appendChild(n),n.context=o,n.path=i,n.rootPath=l,n.isComponent=!0,n.setState&&n.setState({golgi:a}),n}"/"!==l.slice(-1)&&(l=i+"/");let r=customElements.get(t);if(r){return log&&console.log("** component "+t+" already imported"),s(r)}{let o=await import(i+t+".js"),n=customElements.get(t);if(n||(o.load.call(this),n=customElements.get(t),log&&console.log("** component "+t+" had to be imported")),e){return s(n)}return}},loadGroup:async function(t,e,o){"body"===(e=e||"body")&&(e=document.getElementsByTagName("body")[0]),o=o||{},Array.isArray(t)||(t=[t]);let n=t[0].assemblyName;for(const a of t)await this.processComponent(a,n,e,o)},processComponent:async function(t,e,o,n){let a=o;if(t.targetElement){let e=this.getParentComponent.call(a,t.targetElement.componentName);e&&e[t.targetElement.target]&&(a=e[t.targetElement.target])}if("assembly"===t.componentName.split(":")[0]){let e=t.componentName.split("assembly:")[1];if(await this.renderAssembly(e,a,n),t.hook)try{t.hook.call(this)}catch(t){log&&(console.log("Unable to execute hook "+name+" for "+config.componentName),console.log(t))}return}let i=await this.loadComponent(t,e,a,n);t.children&&t.children[0]&&i.childrenTarget&&(t.children.forEach(function(o,n){t.children[n].assemblyName=e}),await this.loadGroup(t.children,i.childrenTarget,n))},loadComponent:async function(t,e,o,n){let a=Object.assign({},t);if(!a.componentName.includes("-")&&!a.componentName.includes(":")){let t=document.createElement(a.componentName);t.textContent=a.textContent;for(let e in a.attributes)t.setAttribute(e,a.attributes[e]);if(t.childrenTarget=t,o.appendChild(t),a.hook)try{"AsyncFunction"===a.hook.constructor.name?await a.hook.call(this):a.hook.call(this)}catch(t){log&&(console.log("Unable to execute hook "+name+" for "+a.componentName),console.log(t))}return t}a.meta&&a.meta.forEach(function(t){golgi.addMetaTag(t)});await Promise.all(["script","css"].map(async t=>{"script"===t&&a.script&&await Promise.all(a.script.map(async t=>{if(!golgi.resourceLoaded.has(t.src)){let e;t.crossorigin&&(e={crossorigin:t.crossorigin}),t.await?await golgi.loadJSAsync(t.src,e):golgi.loadJS(t.src,e),golgi.resourceLoaded.set(t.src,!0)}})),"css"===t&&a.css&&await Promise.all(a.css.map(async t=>{if(!golgi.resourceLoaded.has(t.src)){let e;t.crossorigin&&(e={crossorigin:t.crossorigin}),t.await?await golgi.loadCSSAsync(t.src,e):golgi.loadCSS(t.src,e),golgi.resourceLoaded.set(t.src,!0)}}))}));let i=await this.renderWebComponent(a,o,n);return i.parentComponent&&i.parentComponent.onChildComponentReady&&i.parentComponent.onChildComponentReady.call(i.parentComponent,i),i},renderWebComponent:async function(t,e,o){let n=await this.load(t.componentName,e,o);if(void 0!==n.html){n.innerHTML=n.html,n.rootElement=n.firstElementChild,n.databinding=[],n.querySelectorAll("*").forEach(function(t){if(t.hasAttribute("golgi:prop")){let e=t.getAttribute("golgi:prop");n[e]=t,t.removeAttribute("golgi:prop"),t.ownerComponent=n}if(t.textContent.startsWith("golgi:bind")){let e=t.textContent.split("golgi:bind=")[1]||"dummy",o=function(o){console.log(o),console.log(t);let n=o;"object"==typeof o&&(n=o[e]),t.innerHTML=n};n.databinding.push(o),t.textContent=""}[...t.attributes].forEach(function(e){if(e.name.startsWith("golgi:on_")){let o=e.name.split("golgi:on_")[1],a=e.value;if(n[a]&&"function"==typeof n[a]){let e;e="AsyncFunction"===n[a].constructor.name?async function(t){await n[a](t)}:function(t){n[a](t)},golgi.addHandler.call(n,e,t,o)}t.removeAttribute(e.name)}if(e.value.startsWith("golgi:bind")){let o,a=e.value.split("golgi:bind=")[1];o="INPUT"===t.tagName||"TEXTAREA"===t.tagName&&"value"===e.name?function(e){let o=e;"object"==typeof e&&(o=e[a]),t.value=o}:function(o){let n=o;"object"==typeof o&&(n=o[a]),t.setAttribute(e.name,n)},n.databinding.push(o),t.removeAttribute(e.name)}})}),n.childrenTarget||(n.childrenTarget=n.rootElement),n.childrenTarget.ownerComponent=n;let t="golgi:component-class",e=n.rootElement.getAttribute(t);if(e){e.split(" ").forEach(function(t){n.classList.add(t)}),n.rootElement.removeAttribute(t)}}if(n.getParentComponent=this.getParentComponent.bind(n),n.onUnload=this.onUnload.bind(n),n.registerUnloadMethod=this.registerUnloadMethod.bind(n),n.remove=this.remove.bind(n),n.removeAllByName=this.removeAllByName,n.getComponentByName=this.getComponentByName.bind(this),n.addHandler=this.addHandler.bind(n),n.addMetaTag=this.addMetaTag,n.loadResources=this.loadResources,n.loadJSAsync=this.loadJSAsync,n.loadJS=this.loadJS,n.loadCSSAsync=this.loadCSSAsync,n.loadCSS=this.loadCSS,n.loadGroup=this.loadGroup.bind(this),n.renderAssembly=this.renderAssembly.bind(this),n.renderComponent=this.renderComponent.bind(this),n.renderComponentMap=this.renderComponentMap.bind(this),n.observerStart=this.observerStart,n.methodsToRemove=[],n.golgi_state=this.golgi_state,n.addStateMap=this.addStateMap.bind(n),n.applyDataBinding=this.applyDataBinding.bind(n),o.rootComponent||(o.rootComponent=n),n.rootComponent=o.rootComponent,n.parentComponent=e.ownerComponent,log&&(console.log("Golgi Component instantiated and ready for use:"),console.log(n)),n.onBeforeState&&("AsyncFunction"===n.onBeforeState.constructor.name?await n.onBeforeState():n.onBeforeState()),t.state&&n.setState){for(let e in t.state)"function"==typeof t.state[e]&&(t.state[e]=t.state[e].call(n));n.setState(t.state)}if(t.stateMap){t.state_map=new Map;for(let e in t.stateMap)t.state_map.set(e,t.stateMap[e])}if(t.state_map&&t.state_map.forEach(function(t,e){golgi.stateMap.has(e)||golgi.stateMap.set(e,[]),golgi.stateMap.get(e).push({component:n,method:t})}),n.onBeforeHooks&&n.onBeforeHooks(),t.hook)try{"AsyncFunction"===t.hook.constructor.name?await t.hook.call(n):t.hook.call(n)}catch(e){log&&(console.log("Unable to execute hook "+name+" for "+t.componentName),console.log(e))}return n.onAfterHooks&&n.onAfterHooks(),n},renderComponentMap:async function(t,e,o,n,a,i){let l=-1,s=a.split(":"),r=s[0],c=s[1];void 0!==c&&""!==c||(c="applyDataBinding");for(let a of n){let n=await this.renderComponent(t,e,o);i&&i.call(n,n,a);let s=r+"."+ ++l;n.addStateMap(s,c)}this.golgi_state[r]=n},renderAssembly:async function(t,e,o){let n;if(e||o||"object"!=typeof t?n=t:(e=t.targetElement,o=t.context,n=t.name),!e)return;if(!o)return;if(!n)return;if(""===n)return;let a=o.assemblyPath;""===a&&(a="./"),"/"!==a.slice(-1)&&(a+="/");let i=(await import(a+n+".js")).load.call(this,o),l=i.json||{};return i.gx&&(l=this.parse(i.gx,i.hooks)),l&&(Array.isArray(l)||(l=[l]),l.forEach(function(t,e){l[e].assemblyName=n})),await this.loadGroup(l,e,o)},async renderComponent(t,e,o){"body"===e&&(e=document.getElementsByTagName("body")[0]);let n=e.getElementsByTagName(t).length,a=[{componentName:t}];return await this.loadGroup(a,e,o),e.getElementsByTagName(t)[n]},getParentComponent(t){"string"==typeof(t=t||{})&&(t={match:t});let e=t.prefix||this.tagName.split("-")[0];return function o(n){if(!(n=n.parentNode))return null;if(t.match){if(n.tagName===t.match.toUpperCase())return n}else if(n.tagName.startsWith(e))return n;return o(n)}(this)},getComponentByName(t,e,o){let n,a=[...(o=o||document).getElementsByTagName(t.toUpperCase())];if(!e)return a;for(n=0;n<a.length;n++)if(a[n].name===e)return a[n]},addHandler:function(t,e,o){o||"string"!=typeof e||(o=e,e=null),o=o||"click",(e=e||this.rootElement).addEventListener(o,t),this.listeners||(this.listeners=[]),this.listeners.push({type:o,fn:t,target:e})},registerUnloadMethod(t){this.methodsToRemove.push(t)},onUnload:function(){log&&(console.log("removing Golgi COmponent:"),console.log(this)),this.listeners&&this.listeners.forEach(function(t){log&&(console.log("removing listener"),console.log(t)),t.target.removeEventListener(t.type,t.fn)}),this.methodsToRemove.forEach(function(t){log&&(console.log("invoking custom unload method"),console.log(t)),t()})},remove:function(){!function t(e){[...e.childNodes].forEach(function(e){1===e.nodeType&&(t(e),e.isComponent&&(e.onUnload(),e.parentNode.removeChild(e)))})}(this),this.onUnload(),this.parentNode.removeChild(this)},removeAllByName:function(t,e){let o;(o=e?[...e.getElementsByTagName(t)]:[...document.getElementsByTagName(t)])&&o.forEach(t=>{t.remove()})},parse:function(t,e){let o='<xml xmlns="http://mgateway.com" xmlns:assembly="http://mgateway.com" xmlns:golgi="http://mgateway.com">'+t+"</xml>",n=[];return function t(o,n){[...o.childNodes].forEach(function(a){if(1===a.nodeType){if(["script","css","meta"].includes(a.tagName))return;let i={componentName:a.tagName};if(a.hasAttributes())if(a.tagName.includes("-")||a.tagName.includes(":")){i.state={};let t=[...a.attributes],n={};t.forEach(function(t){let l=t.value;if("true"===l)l=!0;else if("false"===l)l=!1;else try{l=JSON.parse(l)}catch(t){}if("golgi:hook"===t.name&&e&&e[a.tagName]&&e[a.tagName][l]&&(i.hook=e[a.tagName][l]),"golgi:stateMap"===t.name){let t=l.split(":")[0];i.state_map||(i.state_map=new Map);let e=l.split(":")[1];void 0!==e&&""!==e||(e="applyDataBinding"),i.state_map.set(t,e)}else if("golgi:appendTo"===t.name)i.targetElement={componentName:o.tagName,target:l};else if(t.name.includes(".")){let e=t.name.split("."),o=e.length,a=n;e.forEach(function(t,e){a[t]||(a[t]={}),e===o-1?a[t]=l:a=a[t]})}else i.state[t.name]=l});for(let t in n)i.state[t]=n[t]}else i.attributes={},[...a.attributes].forEach(function(t){"golgi:appendTo"===t.name&&(i.targetElement={componentName:o.tagName,target:t.value}),"golgi:hook"===t.name&&e&&e[a.tagName]&&e[a.tagName][t.value]?i.hook=e[a.tagName][t.value]:i.attributes[t.name]=t.value});a.tagName.includes("-")||0!==a.childElementCount||(i.textContent=a.textContent,i.childElementCount=a.childElementCount),a.hasChildNodes()&&(i.children=[],[...a.childNodes].forEach(function(t){if(1===t.nodeType&&["script","css","meta"].includes(t.tagName)){i[t.tagName]||(i[t.tagName]=[]);let e={};[...t.attributes].forEach(function(t){e[t.name]=t.value}),i[t.tagName].push(e)}}),t(a,i.children)),n.push(i)}})}((new DOMParser).parseFromString(o,"text/xml").documentElement,n),n},observerStart(){log&&(console.log("running observerStart on this:"),console.log(this)),this.observerCallback&&golgi.observer.observe(this,{attributes:!0,attributeOldValue:!0,characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0})},observer:new MutationObserver(function(t){t.forEach(function(t){let e=function(t){let e=!1,o=t;do{(o=o.parentElement)&&!o.tagName.includes("-")||(e=!0)}while(!e);return o}(t.target);e.observerCallback&&e.observerCallback(t)})}),addStateMap(t,e){e=e||"applyDataBinding",golgi.stateMap.has(t)||golgi.stateMap.set(t,[]),golgi.stateMap.get(t).push({component:this,method:e})},applyDataBinding(t){this.databinding.forEach(function(e){e(t)}),this.onDataUpdated&&this.onDataUpdated(t)}};golgi.golgi_state=new Proxy(golgi.dataStore,{get:function(t,e,o){return setTimeout(function(){!function(t,e){if(golgi.stateMap.has(t)){let o=golgi.stateMap.get(t);o.forEach((t,n)=>{if(t.component)if(t.component[t.method])t.component[t.method](e);else{let o={};o[t.method]=e,t.component.setState(o)}else o.splice(n,1)})}}(e,t[e])},100),t[e]},set:function(t,e,o){let n=[];function a(t,e){if(log&&(console.log("trying to apply state for mapKey "+t+" = "+e),console.log(golgi.stateMap)),golgi.stateMap.has(t)){let o=golgi.stateMap.get(t);o.forEach((t,n)=>{if(t.component)if(t.component[t.method])t.component[t.method](e);else{let o={};o[t.method]=e,t.component.setState(o)}else o.splice(n,1)})}}return golgi.dataStore[e]=o,"object"==typeof o&&function t(e,o){log&&(console.log("getProps called for "+e),console.log(o)),n.push(e),a(n.join("."),o),Object.entries(o).forEach((e,o)=>{const[i,l]=e;"object"!=typeof l?a(n.join(".")+"."+i,l):(t(i,l),n.pop())})}(e,o),"string"==typeof o&&a(e,o),!0}});export{golgi};